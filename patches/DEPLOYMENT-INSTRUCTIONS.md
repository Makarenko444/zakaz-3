# Инструкции по развертыванию исправлений аудит-лога (клиентская часть)

## Дата: 10 ноября 2025

## Описание изменений

Завершена работа над исправлением отображения пользователей в истории изменений. Клиентские компоненты теперь передают `user_id` при вызове API, что позволяет серверу корректно записывать информацию о пользователе в аудит-лог.

### Изменённые файлы:

1. **app/components/StatusChangeModal.tsx**
   - Добавлен импорт `getCurrentUser`
   - Добавлено состояние `currentUserId`
   - Добавлена функция `loadCurrentUser()`
   - Передается `changed_by` при изменении статуса

2. **app/dashboard/applications/[id]/page.tsx**
   - Добавлен импорт `getCurrentUser`
   - Добавлено состояние `currentUserId`
   - Добавлена функция `loadCurrentUser()`
   - Передается `changed_by` при назначении исполнителя

3. **app/dashboard/applications/[id]/edit/page.tsx**
   - Добавлен импорт `getCurrentUser`
   - Добавлено состояние `currentUserId`
   - Добавлена функция `loadCurrentUser()`
   - Передается `updated_by` при обновлении заявки

4. **app/dashboard/applications/new/page.tsx**
   - Добавлен импорт `getCurrentUser`
   - Добавлено состояние `currentUserId`
   - Добавлена функция `loadCurrentUser()`
   - Передается `created_by` при создании заявки

## Инструкции по развертыванию на продакшен-сервере

### Шаг 1: Скопируйте патч на сервер

```bash
scp patches/2025-11-10-client-audit-fix.patch user@production-server:/tmp/
```

### Шаг 2: Подключитесь к продакшен-серверу

```bash
ssh user@production-server
cd /path/to/zakaz-3
```

### Шаг 3: Проверьте текущий статус

```bash
git status
git log --oneline -3
```

### Шаг 4: Примените патч

```bash
git am /tmp/2025-11-10-client-audit-fix.patch
```

Если возникнет конфликт:
```bash
git am --abort
git apply --check /tmp/2025-11-10-client-audit-fix.patch
git apply /tmp/2025-11-10-client-audit-fix.patch
git add .
git commit -m "Исправлена передача user_id в клиентских компонентах для аудит-лога"
```

### Шаг 5: Соберите проект

```bash
npm run build
```

### Шаг 6: Перезапустите сервис

```bash
sudo systemctl restart zakaz-3
# или
pm2 restart zakaz-3
```

### Шаг 7: Проверьте работу

1. Откройте приложение в браузере
2. Создайте новую заявку или измените существующую
3. Проверьте, что в истории изменений отображается имя пользователя
4. Проверьте в базе данных:
   ```sql
   SELECT id, user_name, user_email, action_type, description, created_at
   FROM zakaz_audit_log
   ORDER BY created_at DESC
   LIMIT 5;
   ```

## Связь с предыдущими изменениями

Эти изменения дополняют серверную часть, которая была развернута ранее:
- Функция `getUserData()` в `lib/audit-log.ts`
- Обновления в 4 API маршрутах для получения данных пользователя

Вместе эти изменения обеспечивают полную функциональность отображения пользователей в аудит-логе.

## Статус выполнения

- ✅ Исправлены все клиентские компоненты (4 файла)
- ✅ Проект успешно собран (npm run build)
- ✅ Изменения закоммичены локально
- ⏳ Ожидается развертывание на продакшен-сервере
- ⏳ Ожидается проверка работоспособности

## Примечания

- Все существующие записи в `zakaz_audit_log` имеют `user_id = NULL` (14 записей)
- Новые записи будут содержать корректные данные пользователя после развертывания
- Исторические записи могут быть обновлены позже, если потребуется
