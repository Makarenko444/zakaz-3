# –ú–∏–≥—Ä–∞—Ü–∏—è 024: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü - –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### ‚úÖ 1. –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î
- **–§–∞–π–ª:** `database/migrations/024_merge_addresses_into_nodes.sql`
- **–î–µ–π—Å—Ç–≤–∏—è:**
  - –°–æ–∑–¥–∞–Ω enum `presence_type` —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏: has_node, has_ao, has_transit_cable, not_present
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ zakaz_nodes: street, house, comment, presence_type
  - –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ zakaz_addresses –≤ zakaz_nodes
  - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –≤ zakaz_applications (address_id ‚Üí node_id)
  - –£–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã zakaz_addresses
  - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤

### ‚úÖ 2. –û–±–Ω–æ–≤–ª–µ–Ω—ã TypeScript —Ç–∏–ø—ã
- **–§–∞–π–ª:** `lib/types.ts`
- **–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
  - –î–æ–±–∞–≤–ª–µ–Ω —Ç–∏–ø `PresenceType`
  - –û–±–Ω–æ–≤–ª–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Node` (–¥–æ–±–∞–≤–ª–µ–Ω—ã street, house, comment, presence_type)
  - –û–±–Ω–æ–≤–ª–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Application` (address_id ‚Üí node_id)

### ‚úÖ 3. –û–±–Ω–æ–≤–ª–µ–Ω—ã API endpoints –¥–ª—è –∞–¥—Ä–µ—Å–æ–≤
- **app/api/addresses/route.ts** - –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤ –∏–∑ zakaz_nodes
- **app/api/addresses/search/route.ts** - –ø–æ–∏—Å–∫ –≤ zakaz_nodes
- **app/api/addresses/save-external/route.ts** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ zakaz_nodes

### ‚úÖ 4. –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- **database/migrations/README_024.md** - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é

### üîß 1. –û–±–Ω–æ–≤–∏—Ç—å API –¥–ª—è –∑–∞—è–≤–æ–∫

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**

#### app/api/applications/route.ts
```typescript
// –ë–´–õ–û:
address_id: validatedData.address_id || null

// –î–û–õ–ñ–ù–û –ë–´–¢–¨:
node_id: validatedData.node_id || null
```

#### app/api/applications/[id]/route.ts
```typescript
// –ë–´–õ–û:
if (address_id !== undefined) {
  updateData.address_id = address_id
}

// –î–û–õ–ñ–ù–û –ë–´–¢–¨:
if (node_id !== undefined) {
  updateData.node_id = node_id
}
```

### üîß 2. –û–±–Ω–æ–≤–∏—Ç—å –∞–¥–º–∏–Ω–∫—É –∞–¥—Ä–µ—Å–æ–≤

#### app/api/admin/addresses/[id]/route.ts
- –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å zakaz_addresses –Ω–∞ zakaz_nodes
- –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É PUT/DELETE –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —É–∑–ª–∞–º–∏

#### app/api/admin/addresses/route.ts
- –£–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –≤—ã—à–µ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å)

### üé® 3. –û–±–Ω–æ–≤–∏—Ç—å UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**–§–∞–π–ª—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:**

```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ address_id
grep -r "address_id" app/dashboard app/components --include="*.tsx" --include="*.ts"
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
1. **AddressLinkWizard.tsx** - –º–∞—Å—Ç–µ—Ä –ø—Ä–∏–≤—è–∑–∫–∏ –∞–¥—Ä–µ—Å–æ–≤
   - –ó–∞–º–µ–Ω–∏—Ç—å address_id –Ω–∞ node_id
   - –û–±–Ω–æ–≤–∏—Ç—å —Ç–∏–ø—ã
   - –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ presence_type

2. **ApplicationCard.tsx / ApplicationForm.tsx** - —Ñ–æ—Ä–º—ã –∑–∞—è–≤–æ–∫
   - –ó–∞–º–µ–Ω–∏—Ç—å –ø–æ–ª—è address_id –Ω–∞ node_id
   - –û–±–Ω–æ–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é

3. **–°–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤ (–∞–¥–º–∏–Ω–∫–∞)** - –µ—Å–ª–∏ –µ—Å—Ç—å
   - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≤ "–£–∑–ª—ã –∏ –∞–¥—Ä–µ—Å–∞"
   - –î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä –ø–æ presence_type
   - –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É presence_type

### üóÑÔ∏è 4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ –ë–î

#### –ß–µ—Ä–µ–∑ psql (–ª–æ–∫–∞–ª—å–Ω–æ):
```bash
# 1. –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø
pg_dump -U user -d zakaz > backup_before_024.sql

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
psql -U user -d zakaz -f database/migrations/024_merge_addresses_into_nodes.sql

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
psql -U user -d zakaz -c "\d zakaz_nodes"
psql -U user -d zakaz -c "SELECT presence_type, COUNT(*) FROM zakaz_nodes GROUP BY presence_type;"
```

#### –ß–µ—Ä–µ–∑ Supabase Dashboard:
1. SQL Editor ‚Üí New query
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `database/migrations/024_merge_addresses_into_nodes.sql`
3. Run
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

### ‚úÖ 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ë–î:**
```sql
\d zakaz_nodes
SELECT presence_type, COUNT(*) FROM zakaz_nodes GROUP BY presence_type;
```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å API endpoints:**
- GET /api/addresses - –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —É–∑–ª—ã
- GET /api/addresses/search?query=–ª–µ–Ω–∏–Ω–∞ - –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–∏—Å–∫
- POST /api/addresses/save-external - –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞–≤–∞—Ç—å —É–∑–ª—ã
- GET /api/applications - –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∑–∞—è–≤–∫–∏ —Å node_id

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å UI:**
- –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É
- –ü—Ä–∏–≤—è–∑–∞—Ç—å –∞–¥—Ä–µ—Å —á–µ—Ä–µ–∑ –º–∞—Å—Ç–µ—Ä
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–¥–º–∏–Ω–∫—É –∞–¥—Ä–µ—Å–æ–≤

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è address_id
grep -r "address_id" app --include="*.ts" --include="*.tsx" | grep -v node_modules

# –ù–∞–π—Ç–∏ –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è zakaz_addresses
grep -r "zakaz_addresses" app --include="*.ts" --include="*.tsx" | grep -v node_modules

# –ù–∞–π—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å —Ñ–æ—Ä–º–∞–º–∏ –∞–¥—Ä–µ—Å–æ–≤
find app -name "*Address*" -o -name "*address*"
```

## –û—Ç–∫–∞—Ç

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫:

```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î –∏–∑ –±—ç–∫–∞–ø–∞
psql -U user -d zakaz < backup_before_024.sql

# –û—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ git
git revert HEAD
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

- ‚úÖ –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –∞–¥—Ä–µ—Å–æ–≤
- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ü–æ–Ω—è—Ç–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –∫–æ–º–ø–∞–Ω–∏–∏
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ –õ–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å

## –¢–∏–ø—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–π –∞–¥—Ä–µ—Å –±—É–¥–µ—Ç –∏–º–µ—Ç—å –æ–¥–∏–Ω –∏–∑ —Ç–∏–ø–æ–≤:

- **has_node** - –ï—Å—Ç—å —É–∑–µ–ª (–ü–ü, –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ)
- **has_ao** - –ï—Å—Ç—å –ê–û (–∞–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–±—ä–µ–∫—Ç)
- **has_transit_cable** - –ï—Å—Ç—å —Ç—Ä–∞–Ω–∑–∏—Ç–Ω—ã–π –∫–∞–±–µ–ª—å
- **not_present** - –ù–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ–º (–∞–¥—Ä–µ—Å –∏–∑ –∑–∞—è–≤–æ–∫, –Ω–æ –±–µ–∑ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã)

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –ª–µ–≥–∫–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å–∞ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Å–µ—Ç–∏.
