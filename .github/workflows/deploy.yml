name: Deploy to VPS

on:
  push:
    branches:
      - main
      - claude/check-deployment-vm-011CUKpxfjRcBBSuLxQLeZBp
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "🚀 Starting deployment..."

            # Navigate to project directory
            cd ~/apps/zakaz-3

            # Store current commit for rollback
            PREVIOUS_COMMIT=$(git rev-parse HEAD)
            echo "📝 Previous commit: $PREVIOUS_COMMIT"

            # Pull latest changes
            echo "📥 Pulling latest changes..."
            git fetch origin
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            # Install dependencies with optimizations
            echo "📦 Installing dependencies..."
            npm ci --production=false --prefer-offline --no-audit

            # Build the application
            echo "🔨 Building application..."
            npm run build

            # Restart PM2
            echo "♻️  Restarting PM2..."
            pm2 restart zakaz-3

            # Wait for application to start
            echo "⏳ Waiting for application to start..."
            sleep 10

            # Health check
            echo "🏥 Running health check..."
            if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:3001 | grep -q "200\|301\|302"; then
              echo "✅ Deployment successful!"
              echo "📊 PM2 Status:"
              pm2 status
            else
              echo "❌ Health check failed! Rolling back..."
              git reset --hard $PREVIOUS_COMMIT
              npm ci --production=false
              npm run build
              pm2 restart zakaz-3
              exit 1
            fi

            echo "🎉 Deployment completed successfully!"
            echo "🌐 Application is running at: https://zakaz2.tomica.ru"

      - name: Notify on success
        if: success()
        run: |
          echo "✅ Deployment to zakaz2.tomica.ru completed successfully"

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Deployment failed"
          exit 1
