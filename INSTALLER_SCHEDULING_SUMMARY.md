# Резюме: Система планирования работ монтажников

**Дата:** 17 ноября 2025
**Версия:** 2.0 (после повторного анализа)
**Статус:** Готово к обсуждению и реализации

---

## 🎯 Краткое резюме

После детального анализа кодовой базы **zakaz-3** подготовлен полный план внедрения системы планирования работ монтажников. Обнаружено, что в проекте уже есть хорошая база для интеграции планирования с минимальными изменениями.

---

## ✅ Что уже работает (важные находки)

### 1. UI для назначения монтажников ✨
**Расположение:** `app/dashboard/applications/[id]/page.tsx:530-588`

Уже есть модальное окно для назначения исполнителя:
- Показывает список всех активных пользователей
- Вызывается кликом на "Исполнитель" в карточке заявки
- Использует API `/api/applications/[id]/assign`

**Что делать:** Расширить эту модалку, добавив поля планирования (дата, время, загрузка)

### 2. API инфраструктура ✨
- ✅ `GET /api/users` - список пользователей
- ✅ `PATCH /api/applications/[id]/assign` - назначение монтажника
- ✅ Audit log для всех действий
- ✅ TypeScript типы для всех сущностей

**Что делать:** Добавить новые endpoints, не ломая существующие

### 3. Статусы заявок ✨
10 статусов с четким жизненным циклом:
- `queue_install` - момент для планирования работ
- `install` - работа в процессе
- `installed` - работа завершена

**Что делать:** Использовать логику статусов для управления планированием

---

## 📋 Два варианта реализации

### Вариант 1: Быстрый MVP (2 недели) ⭐ РЕКОМЕНДУЕТСЯ

**Подход:**
- Добавить поля планирования прямо в таблицу `zakaz_applications`
- Расширить существующую модалку назначения
- Создать простой календарь на неделю
- Без бригад (только индивидуальные монтажники)

**Новые поля в БД:**
```sql
ALTER TABLE zakaz_applications ADD (
  scheduled_date DATE,
  scheduled_time_start TIME,
  scheduled_time_end TIME,
  estimated_duration_hours DECIMAL(4,2),
  actual_start_at TIMESTAMPTZ,
  actual_end_at TIMESTAMPTZ,
  work_notes TEXT
);
```

**Преимущества:**
- ✅ Минимум изменений в коде
- ✅ Обратная совместимость
- ✅ Быстрое тестирование
- ✅ Можно мигрировать на вариант 2 позже

**Что будет:**
- Назначение + планирование через одну модалку
- Показ загрузки монтажников при выборе даты
- Календарь на неделю с загрузкой
- Предупреждения о конфликтах расписания

---

### Вариант 2: Полная версия (4-6 недель)

**Подход:**
- Создать отдельные таблицы для бригад и назначений
- Поддержка как бригад, так и индивидуалов
- История переназначений
- Drag-and-drop календарь

**Новые таблицы:**
- `zakaz_brigades` - бригады монтажников
- `zakaz_brigade_members` - состав бригад
- `zakaz_work_assignments` - все назначения работ

**Когда выбирать:**
- Точно нужны бригады в ближайшее время
- Готовы потратить больше времени
- Нужна детальная история

---

## 🚀 Рекомендуемый план действий

### Этап 1: MVP (2 недели)

**Неделя 1: Backend**
1. Создать миграцию 012 - добавить поля планирования
2. Создать API `/api/applications/[id]/schedule`
3. Создать API `/api/workload/engineers`
4. Добавить утилиты расчета загрузки
5. Обновить типы TypeScript

**Неделя 2: Frontend**
1. Расширить модалку назначения (добавить дату/время)
2. Показывать загрузку при выборе монтажника
3. Создать страницу `/dashboard/schedule` с календарем
4. Обновить карточку заявки (показать дату планирования)
5. Добавить индикаторы статусов

**Результат:**
- ✅ Работающее планирование за 2 недели
- ✅ Интеграция с существующим UI
- ✅ Можно тестировать на реальных данных

---

### Этап 2: Улучшения (опционально, +2 недели)
- Drag-and-drop календарь
- Дашборд с виджетами
- Статистика и графики
- Telegram уведомления

### Этап 3: Бригады (опционально, +3 недели)
- Создание таблиц для бригад
- Миграция данных
- UI для управления бригадами
- Расширенное планирование

---

## 🔗 Интеграция с текущим кодом

### Файлы, которые нужно изменить:

1. **БД:** `database/migrations/012_add_scheduling_fields.sql` (новый)
2. **Типы:** `lib/types.ts` (добавить поля в `Application`)
3. **API:** `app/api/applications/[id]/schedule/route.ts` (новый)
4. **API:** `app/api/workload/engineers/route.ts` (новый)
5. **Утилиты:** `lib/scheduling-utils.ts` (новый)
6. **Модалка:** `app/dashboard/applications/[id]/page.tsx` (расширить)
7. **Компонент:** `app/components/EngineerWorkloadCard.tsx` (новый)
8. **Страница:** `app/dashboard/schedule/page.tsx` (новая)

### Файлы, которые НЕ трогаем:
- ✅ `app/api/applications/[id]/assign/route.ts` - продолжит работать
- ✅ `app/api/users/route.ts` - используем как есть
- ✅ `lib/audit-log.ts` - используем для логирования
- ✅ Все остальные компоненты

---

## 📊 Ключевые функции системы

### 1. Постановка задач монтажникам
**Как будет работать:**
```
Оператор → Открывает заявку со статусом "queue_install"
         → Кликает на "Исполнитель"
         → В модалке выбирает монтажника
         → Выбирает дату и время
         → Видит загрузку монтажника (2/8 часов занято)
         → Система предупреждает о конфликтах
         → Сохраняет назначение + планирование
```

### 2. Планирование загрузки
**Что будет видно:**
```
Монтажник: Иванов Иван
Дата: 20 ноября 2025

Загрузка: 2/10 часов (20%) 🟢 Доступен

Запланированные работы:
- 08:00-10:00 (2ч) Заявка #115, ул. Ленина 56

Свободные слоты:
- 10:00-18:00 (8 часов)
```

### 3. Дашборд-календарь
**Что будет показывать:**
```
Календарь на неделю:

             Пн 20     Вт 21     Ср 22     Чт 23     Пт 24
Иванов И.   🟢 2/8ч   🟡 7/8ч   🔴 9/8ч   🟢 3/8ч   🟢 4/8ч
Петров П.   🟡 7/8ч   🟢 4/8ч   🟢 3/8ч   🟡 6/8ч   🔴 8/8ч

🟢 Доступен (<70%)  🟡 Загружен (70-90%)  🔴 Перегружен (>90%)
```

---

## ⚡ Связь со статусами заявок

### Момент планирования:
```
contract → queue_install (⚡ ПЛАНИРУЕМ ЗДЕСЬ)
          ↓
       Назначить монтажника + дату/время
          ↓
       install (начало работы)
          ↓
       installed (завершение)
```

### UI индикаторы:
- ⏳ **queue_install** без даты → "❗ Требуется планирование!"
- 📅 **queue_install** с датой → "Запланировано на 20.11 в 14:00"
- 🔧 **install** → "В работе с 14:05"
- ✅ **installed** → "Завершено за 2.5 часа (план: 3ч)"

---

## 🎨 Примеры UI

### Расширенная модалка назначения:
```
┌─────────────────────────────────────────┐
│ Назначить исполнителя и запланировать   │
├─────────────────────────────────────────┤
│                                         │
│ 📅 Дата выполнения                     │
│ [20.11.2025]                           │
│                                         │
│ ⏰ Время                               │
│ Начало: [14:00]  Окончание: [17:00]   │
│ Длительность: ~3 часа                  │
│                                         │
│ 👷 Выберите монтажника:                │
│                                         │
│ ○ Иванов Иван (engineer) 🟢           │
│   Свободен: 8/10 часов (20% занято)    │
│   08:00-10:00 Заявка #115              │
│   Доступен: 10:00-18:00                │
│                                         │
│ ○ Петров Петр (engineer) 🔴           │
│   Занят: 9/10 часов (90% занято)       │
│   ⚠️ Перегружен на эту дату            │
│                                         │
│ 📝 Комментарий для монтажника          │
│ [Клиент доступен только после 14:00]   │
│                                         │
│ [Отмена]           [Назначить]         │
└─────────────────────────────────────────┘
```

### Календарь загрузки:
```
Неделя 20-26 ноября 2025

┌─────────┬──────┬──────┬──────┬──────┬──────┐
│         │ Пн   │ Вт   │ Ср   │ Чт   │ Пт   │
├─────────┼──────┼──────┼──────┼──────┼──────┤
│ Иванов  │ 🟢   │ 🟡   │ 🔴   │ 🟢   │ 🟢   │
│ Иван    │ 2/8ч │ 7/8ч │ 9/8ч │ 3/8ч │ 4/8ч │
│         │      │      │      │      │      │
│         │ 08-10│ 09-12│ 08-11│ 10-13│ 08-12│
│         │ #115 │ #118 │ #120 │ #125 │ #128 │
│         │      │ 13-17│ 12-17│      │      │
│         │      │ #119 │ #121 │      │      │
│         │      │      │ 17-19│      │      │
│         │      │      │ #122 │      │      │
├─────────┼──────┼──────┼──────┼──────┼──────┤
│ Петров  │ 🟡   │ 🟢   │ 🟢   │ 🟡   │ 🔴   │
│ Петр    │ 7/8ч │ 4/8ч │ 3/8ч │ 6/8ч │ 8/8ч │
└─────────┴──────┴──────┴──────┴──────┴──────┘

Клик на ячейку → детали / переназначение
```

---

## 🔄 Обратная совместимость

### Что гарантируется:
- ✅ Существующие заявки продолжат работать (поля `NULL`)
- ✅ Текущий API `/api/applications/[id]/assign` не изменится
- ✅ Модалка назначения будет расширена, не заменена
- ✅ Можно не планировать дату - система работает как раньше
- ✅ При переходе на вариант 2 - миграция данных без потерь

### Что НЕ сломается:
- Текущая функциональность назначения монтажников
- Аудит-лог
- Комментарии и файлы
- Статусы заявок

---

## 💰 Оценка трудозатрат

### Вариант 1 (быстрый MVP):
- **Backend:** 3-4 дня
- **Frontend:** 5-6 дней
- **Тестирование:** 2 дня
- **Итого:** ~2 недели

### Вариант 2 (полная версия):
- **Backend:** 8-10 дней
- **Frontend:** 10-12 дней
- **Тестирование:** 4 дня
- **Итого:** ~4-6 недель

### Этап улучшений (опционально):
- **Drag-and-drop:** +3 дня
- **Дашборд виджеты:** +3 дня
- **Статистика:** +2 дня
- **Telegram:** +3 дня

---

## ❓ Вопросы для принятия решения

Перед началом разработки нужно ответить:

### 1. Вариант реализации
- [ ] Вариант 1: Быстрый MVP (2 недели) ⭐
- [ ] Вариант 2: Полная версия с бригадами (4-6 недель)
- [ ] Гибридный: MVP → затем бригады

### 2. Рабочее время
- [ ] Рабочий день: с ___:___ до ___:___
- [ ] Максимальная загрузка: ___ часов в день
- [ ] Учитывать выходные: Да / Нет

### 3. Бригады
- [ ] Нужны бригады в MVP: Да / Нет
- [ ] Можно добавить позже: Да / Нет
- [ ] Средний размер бригады: ___ человек

### 4. Конфликты расписания
- [ ] Запрещать накладывающиеся работы: Да / Нет
- [ ] Только предупреждать: Да / Нет
- [ ] Разрешать перегрузку: Да / Нет

### 5. Приоритеты
- [ ] Календарь важнее всего
- [ ] Дашборд важнее всего
- [ ] Быстрый запуск важнее всего

---

## 📚 Созданные документы

1. **INSTALLER_SCHEDULING_PLAN.md** (45 KB)
   - Полный план реализации
   - Два варианта архитектуры
   - Макеты UI
   - Поэтапный план

2. **INSTALLER_SCHEDULING_CODE_EXAMPLES.md** (21 KB)
   - Готовые миграции БД
   - Примеры API endpoints
   - React компоненты
   - TypeScript типы

3. **INSTALLER_SCHEDULING_SUMMARY.md** (этот файл)
   - Краткое резюме
   - Ключевые выводы
   - Быстрый старт

4. **ANALYSIS_SUMMARY.md** (10 KB)
   - Анализ текущей архитектуры
   - Что есть, чего нет
   - Критические ограничения

5. **ARCHITECTURE_REPORT.md** (28 KB)
   - Детальный отчет по архитектуре
   - Все таблицы и API
   - Технологический стек

---

## 🎯 Следующие шаги

1. **Обсудить** этот план с командой
2. **Ответить** на вопросы из раздела выше
3. **Выбрать** вариант реализации (1 или 2)
4. **Согласовать** приоритеты и сроки
5. **Начать** разработку с миграции БД

---

## ✅ Готовность к реализации

- ✅ Проведен полный анализ кодовой базы
- ✅ Найдены все точки интеграции
- ✅ Подготовлены примеры кода
- ✅ Продуман путь миграции
- ✅ Учтена обратная совместимость
- ✅ Готовы SQL миграции
- ✅ Готовы TypeScript типы
- ✅ Готовы примеры компонентов

**Можно начинать разработку!** 🚀

---

**Автор:** Claude (AI Assistant)
**Дата:** 17 ноября 2025
**Контакт:** через GitHub Issues проекта zakaz-3
