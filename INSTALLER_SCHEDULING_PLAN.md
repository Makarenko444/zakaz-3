# План реализации системы планирования работ монтажников

**Дата:** 17 ноября 2025
**Статус:** Черновик для обсуждения
**Версия:** 1.0

---

## 📋 Оглавление

1. [Текущая ситуация](#текущая-ситуация)
2. [Требования к системе](#требования-к-системе)
3. [Предлагаемая архитектура](#предлагаемая-архитектура)
4. [Постановка задач монтажникам](#постановка-задач-монтажникам)
5. [Планирование загрузки](#планирование-загрузки)
6. [Дашборд-календарь](#дашборд-календарь)
7. [План реализации](#план-реализации)
8. [Альтернативные подходы](#альтернативные-подходы)

---

## 🔍 Текущая ситуация

### Что уже есть:
- ✅ Заявки с базовыми полями (`zakaz_applications`)
- ✅ Монтажники как пользователи с ролью `engineer`
- ✅ Назначение одного монтажника на заявку (`assigned_to`)
- ✅ Система статусов (10 статусов)
- ✅ История изменений и аудит-лог (`zakaz_audit_log`)
- ✅ API для назначения монтажника (`PATCH /api/applications/[id]/assign`)
- ✅ API для получения списка пользователей (`GET /api/users`)
- ✅ **Модальное окно назначения исполнителя** в UI (app/dashboard/applications/[id]/page.tsx:530-588)
- ✅ Компоненты для модальных окон (StatusChangeModal, AuditLogModal)
- ✅ Типы TypeScript для всех сущностей (lib/types.ts)

### Чего не хватает:
- ❌ **Управление бригадами** (несколько монтажников на одну задачу)
- ❌ **Планирование по датам** (когда конкретно выполнять работу)
- ❌ **Временные слоты** (время начала/окончания работ)
- ❌ **Визуализация загрузки** (календарь, дашборд)
- ❌ **Отслеживание фактического времени** (когда реально начали/закончили)
- ❌ **Оценка длительности работ** (сколько часов требуется)
- ❌ **Интеграция планирования с модалкой назначения**

### Важные детали текущей реализации:

**Модалка назначения исполнителя:**
```typescript
// Расположение: app/dashboard/applications/[id]/page.tsx (строки 530-588)
// Показывает список всех активных пользователей
// Позволяет назначить или снять назначение
// Использует API: PATCH /api/applications/[id]/assign
```

**Связь со статусами:**
- `queue_install` - заявка в очереди на монтаж (можно планировать)
- `install` - монтаж в процессе (работа началась)
- `installed` - монтаж завершен

**Таблицы удалены в миграции 010:**
- `zakaz_brigades`, `zakaz_brigade_members`, `zakaz_work_slots` были удалены как неиспользуемые
- При внедрении планирования нужно создать их заново

### Логика работы со статусами:

**Жизненный цикл заявки с планированием:**

1. **new** → **thinking** → **estimation** → **waiting_payment** → **contract**
   - На этих этапах планирование еще не актуально
   - Оператор работает с клиентом

2. **contract** → **queue_install** ⚡ **ЗДЕСЬ ПЛАНИРУЕМ**
   - Статус `queue_install` = "В очереди на монтаж"
   - **Это момент, когда нужно назначить монтажника И запланировать дату**
   - UI должен подсказывать: "Назначьте исполнителя и дату монтажа"

3. **queue_install** → **install** (работа началась)
   - Переход в статус `install` означает, что монтажник приехал на объект
   - Можно фиксировать `actual_start_at = NOW()`
   - В будущем: кнопка "Начать работу" для монтажника

4. **install** → **installed** (работа завершена)
   - Монтажник завершил работу
   - Фиксируем `actual_end_at = NOW()`
   - В будущем: кнопка "Завершить работу"

5. **rejected** / **no_tech** - заявка не выполняется
   - Планирование не требуется
   - Если было запланировано - освобождается слот

**Правила планирования по статусам:**
```typescript
// Можно планировать
const canSchedule = ['contract', 'queue_install'];

// Работа запланирована
const isScheduled = ['queue_install', 'install'];

// Работа в процессе
const isInProgress = ['install'];

// Работа завершена
const isCompleted = ['installed'];

// Не требует планирования
const noScheduleNeeded = ['new', 'thinking', 'estimation', 'waiting_payment', 'rejected', 'no_tech'];
```

**UI индикаторы:**
- ⏳ `queue_install` + нет даты → "Требуется планирование!"
- 📅 `queue_install` + есть дата → "Запланировано на [дата]"
- 🔧 `install` → "В работе с [время]"
- ✅ `installed` → "Завершено за [фактическое время]"

---

## 🎯 Требования к системе

### 1. Постановка задач
**Как оператор/руководитель должен ставить задачу:**

```
Заявка #123: Подключение квартиры, ул. Ленина 56, кв. 12

Задача:
- Назначить: Бригада №1 (Иванов И.И., Петров П.П.)
- Дата: 20 ноября 2025
- Время: 14:00 - 17:00 (3 часа)
- Приоритет: Высокий
- Комментарий: "Клиент доступен только после 14:00"
```

**Что нужно учитывать:**
- Один монтажник или бригада (несколько человек)
- Дата и время выполнения
- Ожидаемая длительность работ
- Приоритет/срочность
- Комментарии для монтажника

### 2. Планирование загрузки
**Что нужно видеть:**
- Сколько часов работы у каждого монтажника на день/неделю
- Какие заявки запланированы
- Есть ли свободное время для новых задач
- Кто перегружен, кто свободен

**Правила планирования:**
- Рабочий день: 8:00 - 18:00 (10 часов)
- Максимальная загрузка: 8 часов работы + 2 часа на дорогу
- Нельзя планировать больше 8 часов работ в день
- Учитывать выходные дни

### 3. Дашборд-календарь
**Что должен показывать:**
- Календарь на неделю/месяц
- Загрузка каждого монтажника по дням
- Запланированные заявки
- Drag-and-drop для перепланирования
- Цветовая индикация (свободен, занят, перегружен)

---

## 🏗 Предлагаемая архитектура

### Вариант 1: Индивидуальные монтажники (быстрая реализация)

**Подходит, если:**
- Монтажники работают в основном по одному
- Не нужно управление бригадами в ближайшее время
- Нужно быстро запустить планирование

**Изменения в БД:**

```sql
-- Добавляем поля планирования в applications
ALTER TABLE zakaz_applications ADD COLUMN IF NOT EXISTS
  scheduled_date DATE,                      -- Дата выполнения
  scheduled_time_start TIME,                -- Время начала
  scheduled_time_end TIME,                  -- Время окончания
  estimated_duration_hours DECIMAL(4,2),    -- Оценка длительности (часы)
  actual_start_at TIMESTAMPTZ,              -- Фактическое начало
  actual_end_at TIMESTAMPTZ,                -- Фактическое окончание
  work_notes TEXT;                          -- Заметки для монтажника

-- Создаем индекс для быстрого поиска по дате
CREATE INDEX idx_applications_scheduled_date
ON zakaz_applications(scheduled_date, assigned_to)
WHERE scheduled_date IS NOT NULL;
```

**Плюсы:**
- ✅ Минимальные изменения БД
- ✅ Быстрая реализация (1-2 недели)
- ✅ Простая логика назначения

**Минусы:**
- ❌ Один монтажник на заявку
- ❌ Нет управления бригадами
- ❌ Нужна миграция данных при переходе на бригады

---

### Вариант 2: Бригады + индивидуальные монтажники (полная реализация)

**Подходит, если:**
- Есть работы, требующие нескольких человек
- Планируется расширение функционала
- Готовы потратить больше времени на разработку

**Структура БД:**

```sql
-- 1. Таблица бригад
CREATE TABLE zakaz_brigades (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,               -- "Бригада №1"
  lead_id UUID REFERENCES zakaz_users(id),  -- Руководитель бригады
  description TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. Состав бригад
CREATE TABLE zakaz_brigade_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  brigade_id UUID NOT NULL REFERENCES zakaz_brigades(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES zakaz_users(id) ON DELETE CASCADE,
  role VARCHAR(50),                         -- "lead", "engineer", "helper"
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(brigade_id, user_id)
);

-- 3. Планирование работ (временные слоты)
CREATE TABLE zakaz_work_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  application_id UUID NOT NULL REFERENCES zakaz_applications(id) ON DELETE CASCADE,

  -- Кто назначен: либо бригада, либо индивидуальный монтажник
  brigade_id UUID REFERENCES zakaz_brigades(id),
  engineer_id UUID REFERENCES zakaz_users(id),

  -- Планирование
  scheduled_date DATE NOT NULL,
  scheduled_time_start TIME NOT NULL,
  scheduled_time_end TIME NOT NULL,
  estimated_duration_hours DECIMAL(4,2),

  -- Выполнение
  status VARCHAR(50) DEFAULT 'planned',     -- planned, in_progress, completed, cancelled
  actual_start_at TIMESTAMPTZ,
  actual_end_at TIMESTAMPTZ,
  actual_duration_hours DECIMAL(4,2),

  -- Дополнительно
  notes TEXT,
  created_by UUID REFERENCES zakaz_users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  -- Проверка: должен быть назначен либо бригада, либо монтажник
  CONSTRAINT check_assignment CHECK (
    (brigade_id IS NOT NULL AND engineer_id IS NULL) OR
    (brigade_id IS NULL AND engineer_id IS NOT NULL)
  )
);

-- 4. Индексы для быстрого поиска
CREATE INDEX idx_work_assignments_date ON zakaz_work_assignments(scheduled_date);
CREATE INDEX idx_work_assignments_brigade ON zakaz_work_assignments(brigade_id, scheduled_date);
CREATE INDEX idx_work_assignments_engineer ON zakaz_work_assignments(engineer_id, scheduled_date);
CREATE INDEX idx_work_assignments_application ON zakaz_work_assignments(application_id);
```

**Обновление существующей таблицы:**

```sql
-- Добавляем ссылку на текущее назначение в applications
ALTER TABLE zakaz_applications ADD COLUMN IF NOT EXISTS
  current_assignment_id UUID REFERENCES zakaz_work_assignments(id);
```

**Плюсы:**
- ✅ Гибкость: поддержка бригад и индивидуалов
- ✅ История назначений (можно переназначать)
- ✅ Детальное планирование по времени
- ✅ Отслеживание фактического времени
- ✅ Масштабируемость

**Минусы:**
- ❌ Больше времени на разработку (3-4 недели)
- ❌ Сложнее логика назначения
- ❌ Больше таблиц в БД

---

## 🔗 Интеграция с существующим кодом

### Что уже работает и как это использовать:

#### 1. Модальное окно назначения исполнителя
**Расположение:** `app/dashboard/applications/[id]/page.tsx:530-588`

Текущий функционал:
- Показывает список всех активных пользователей
- Позволяет назначить/снять назначение
- Вызывается кликом на "Исполнитель" в карточке заявки

**Что нужно сделать:**
- Расширить модалку, добавив поля планирования (дата, время)
- Показывать загрузку монтажника на выбранную дату
- Предупреждать о конфликтах расписания

#### 2. API назначения
**Endpoint:** `PATCH /api/applications/[id]/assign`
**Файл:** `app/api/applications/[id]/assign/route.ts`

Текущий функционал:
- Назначает/снимает монтажника
- Логирует в audit_log
- Возвращает обновленную заявку

**Что нужно сделать:**
- Создать новый endpoint `PATCH /api/applications/[id]/schedule`
- Или расширить существующий для приема полей планирования

#### 3. API списка пользователей
**Endpoint:** `GET /api/users`
**Файл:** `app/api/users/route.ts`

Текущий функционал:
- Возвращает всех активных пользователей
- Поддерживает фильтрацию по роли (через query params)

**Что нужно сделать:**
- Расширить ответ, добавив информацию о загрузке
- Или создать отдельный endpoint `GET /api/workload/engineers`

#### 4. Типы TypeScript
**Файл:** `lib/types.ts`

Текущие типы:
- `User` - пользователь с ролью
- `Application` - заявка с полем `assigned_to`
- `ApplicationStatus` - 10 статусов

**Что нужно добавить:**
```typescript
// В интерфейс Application
scheduled_date?: string;
scheduled_time_start?: string;
scheduled_time_end?: string;
estimated_duration_hours?: number;
work_notes?: string;

// Новые типы
interface EngineerWorkload { ... }
interface WorkAssignment { ... }
interface Brigade { ... }
```

---

## 📝 Постановка задач монтажникам

### UI/UX для постановки задачи

#### Экран 1: Расширенная модалка назначения (обновленная версия)
```
┌─────────────────────────────────────────────────────────┐
│ Заявка #123                              [Редактировать] │
├─────────────────────────────────────────────────────────┤
│ Адрес: ул. Ленина 56, кв. 12                            │
│ Клиент: Иванов Иван Иванович                            │
│ Телефон: +7 999 111 22 33                               │
│ Статус: В очереди на монтаж                             │
│ Срочность: Высокая 🔴                                    │
│                                                           │
│ ┌───────────────────────────────────────────────────┐   │
│ │ 👷 Назначить монтажника                           │   │
│ │                                                   │   │
│ │ [ Выбрать монтажника/бригаду ▼ ]                │   │
│ │                                                   │   │
│ │ 📅 Запланировать работу                          │   │
│ │ Дата: [20.11.2025]  Время: [14:00] - [17:00]   │   │
│ │ Длительность: ~3 часа                            │   │
│ │                                                   │   │
│ │ 📝 Комментарий для монтажника:                   │   │
│ │ [Клиент доступен только после 14:00]             │   │
│ │                                                   │   │
│ │ [Отмена]                    [Назначить и спланировать] │
│ └───────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

#### Экран 2: Выбор монтажника с показом загрузки
```
┌─────────────────────────────────────────────────────────┐
│ Выбор монтажника на 20 ноября 2025                      │
├─────────────────────────────────────────────────────────┤
│                                                           │
│ 🔍 [Поиск...]                                            │
│                                                           │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ ⚪ Индивидуальные монтажники                        │ │
│ ├─────────────────────────────────────────────────────┤ │
│ │ ○ Иванов Иван (engineer)         2/8 часов 🟢     │ │
│ │   8:00-12:00 Заявка #115                           │ │
│ │   Свободен: 12:00-18:00 (6 часов)                  │ │
│ │                                                     │ │
│ │ ○ Петров Петр (engineer)         7/8 часов 🟡     │ │
│ │   8:00-10:00 Заявка #102                           │ │
│ │   11:00-16:00 Заявка #118                          │ │
│ │   Свободен: 16:00-18:00 (2 часа)                   │ │
│ │                                                     │ │
│ │ ○ Сидоров Сидор (engineer)       8/8 часов 🔴     │ │
│ │   8:00-12:00 Заявка #99                            │ │
│ │   13:00-17:00 Заявка #101                          │ │
│ │   Полностью занят                                  │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                           │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ ⚪ Бригады                                          │ │
│ ├─────────────────────────────────────────────────────┤ │
│ │ ○ Бригада №1 (Иванов, Васильев)  4/16 часов 🟢   │ │
│ │   10:00-14:00 Заявка #88                           │ │
│ │   Свободна: 14:00-18:00 (8 часов)                  │ │
│ │                                                     │ │
│ │ ○ Бригада №2 (Петров, Николаев)  14/16 часов 🔴  │ │
│ │   8:00-16:00 Заявка #91                            │ │
│ │   Свободна: 16:00-18:00 (4 часа)                   │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                           │
│ [Отмена]                                [Выбрать]       │
└─────────────────────────────────────────────────────────┘
```

### API для постановки задачи

```typescript
// POST /api/work-assignments
{
  "application_id": "uuid",

  // Назначение (одно из двух)
  "brigade_id": "uuid",      // ИЛИ
  "engineer_id": "uuid",

  // Планирование
  "scheduled_date": "2025-11-20",
  "scheduled_time_start": "14:00",
  "scheduled_time_end": "17:00",
  "estimated_duration_hours": 3,

  // Дополнительно
  "notes": "Клиент доступен только после 14:00"
}

// Ответ
{
  "id": "uuid",
  "application": { /* данные заявки */ },
  "assigned": {
    "type": "engineer",  // "engineer" | "brigade"
    "id": "uuid",
    "name": "Иванов Иван",
    "members": []  // для бригады - список участников
  },
  "schedule": {
    "date": "2025-11-20",
    "time_start": "14:00",
    "time_end": "17:00",
    "duration_hours": 3
  },
  "status": "planned",
  "created_at": "2025-11-17T10:00:00Z"
}
```

---

## 📊 Планирование загрузки

### Расчет загрузки монтажника

```typescript
interface EngineerWorkload {
  engineer_id: string;
  engineer_name: string;
  date: string;

  // Рабочий день
  work_day_start: string;      // "08:00"
  work_day_end: string;        // "18:00"
  total_work_hours: number;    // 10

  // Загрузка
  planned_work_hours: number;  // 7
  available_hours: number;     // 3
  utilization_percent: number; // 70%

  // Статус
  status: "available" | "busy" | "overloaded";

  // Детали
  assignments: WorkAssignment[];
  free_slots: TimeSlot[];
}

interface TimeSlot {
  start: string;    // "12:00"
  end: string;      // "15:00"
  duration: number; // 3
}

// Пример расчета
function calculateEngineerWorkload(engineerId: string, date: string) {
  const assignments = getAssignmentsForDate(engineerId, date);
  const totalPlanned = assignments.reduce((sum, a) => sum + a.estimated_duration_hours, 0);
  const available = 10 - totalPlanned;
  const utilization = (totalPlanned / 10) * 100;

  let status: "available" | "busy" | "overloaded";
  if (totalPlanned >= 9) status = "overloaded";
  else if (totalPlanned >= 7) status = "busy";
  else status = "available";

  return {
    planned_work_hours: totalPlanned,
    available_hours: available,
    utilization_percent: utilization,
    status,
    assignments,
    free_slots: calculateFreeSlots(assignments)
  };
}
```

### API для получения загрузки

```typescript
// GET /api/workload/engineers?date=2025-11-20
{
  "date": "2025-11-20",
  "engineers": [
    {
      "engineer_id": "uuid",
      "engineer_name": "Иванов Иван",
      "planned_work_hours": 2,
      "available_hours": 8,
      "utilization_percent": 20,
      "status": "available",
      "assignments": [
        {
          "id": "uuid",
          "application_id": "uuid",
          "application_number": 115,
          "time_start": "08:00",
          "time_end": "10:00",
          "duration_hours": 2,
          "address": "ул. Ленина 56"
        }
      ],
      "free_slots": [
        { "start": "10:00", "end": "18:00", "duration": 8 }
      ]
    },
    // ... другие монтажники
  ],
  "summary": {
    "total_engineers": 5,
    "available": 2,
    "busy": 2,
    "overloaded": 1
  }
}

// GET /api/workload/engineers/{id}?start_date=2025-11-20&end_date=2025-11-24
{
  "engineer": { /* данные монтажника */ },
  "period": {
    "start_date": "2025-11-20",
    "end_date": "2025-11-24"
  },
  "daily_workload": [
    {
      "date": "2025-11-20",
      "planned_work_hours": 2,
      "assignments_count": 1,
      "status": "available"
    },
    {
      "date": "2025-11-21",
      "planned_work_hours": 7,
      "assignments_count": 3,
      "status": "busy"
    },
    // ...
  ],
  "summary": {
    "total_planned_hours": 24,
    "total_available_hours": 26,
    "avg_utilization": 48
  }
}
```

---

## 📅 Дашборд-календарь

### Макет главного дашборда

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ 📊 Планирование работ монтажников                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│ [Календарь]  [Канбан-доска]  [Список]                                       │
│                                                                               │
│ ◀ Неделя 20-26 ноября 2025 ▶                                                │
│                                                                               │
├────────┬──────────┬──────────┬──────────┬──────────┬──────────┬──────────┤
│        │ Пн 20    │ Вт 21    │ Ср 22    │ Чт 23    │ Пт 24    │ Сб 25    │
│        │ Сегодня  │          │          │          │          │ Выходной │
├────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ Иванов │ 🟢 2/8ч │ 🟡 7/8ч │ 🔴 9/8ч │ 🟢 3/8ч │ 🟢 4/8ч │    -     │
│ Иван   │          │          │          │          │          │          │
│        │ 08-10    │ 09-12    │ 08-11    │ 10-13    │ 08-12    │          │
│        │ #115     │ #118     │ #120     │ #125     │ #128     │          │
│        │          │ 13-17    │ 12-17    │          │          │          │
│        │          │ #119     │ #121     │          │          │          │
│        │          │          │ 17-19⚠️ │          │          │          │
│        │          │          │ #122     │          │          │          │
├────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ Петров │ 🟡 7/8ч │ 🟢 4/8ч │ 🟢 3/8ч │ 🟡 6/8ч │ 🔴 8/8ч │    -     │
│ Петр   │          │          │          │          │          │          │
│        │ 08-15    │ 10-14    │ 14-17    │ 08-11    │ 08-16    │          │
│        │ #116     │ #123     │ #126     │ #129     │ #130     │          │
│        │          │          │          │ 12-15    │          │          │
│        │          │          │          │ #124     │          │          │
├────────┼──────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ Бригада│ 🟢 4/16ч│ 🟡 12/16ч│ 🟢 8/16ч│ 🟡 10/16ч│ 🔴 16/16ч│   -     │
│ №1     │          │          │          │          │          │          │
│        │ 10-14    │ 08-14    │ 10-14    │ 09-14    │ 08-16    │          │
│        │ #88      │ #92      │ #95      │ #98      │ #100     │          │
│        │          │ 15-17    │          │ 15-17    │          │          │
│        │          │ #93      │          │ #99      │          │          │
└────────┴──────────┴──────────┴──────────┴──────────┴──────────┴──────────┘

🟢 Доступен (< 70%)   🟡 Загружен (70-90%)   🔴 Перегружен (> 90%)   ⚠️ Переработка

[+ Новая заявка]  [Фильтры]  [Экспорт]
```

### Календарь с drag-and-drop

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ Перетащите заявку для переназначения/переноса                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│ Иванов Иван - Среда 22 ноября                                               │
│                                                                               │
│ 08:00 ┌──────────────────────┐                                              │
│       │ #120 - ул. Ленина 56 │ ← можно перетащить на другого монтажника     │
│ 09:00 │ 3 часа               │    или изменить время                        │
│       └──────────────────────┘                                              │
│ 10:00                                                                        │
│ 11:00                                                                        │
│ 12:00 ┌──────────────────────┐                                              │
│       │ #121 - ул. Мира 12   │                                              │
│ 13:00 │ 5 часов              │                                              │
│ 14:00 │                      │                                              │
│ 15:00 │                      │                                              │
│ 16:00 └──────────────────────┘                                              │
│ 17:00 ┌──────────────────────┐ ⚠️ Выходит за рабочее время!                │
│       │ #122 - ул. Садовая 8 │                                              │
│ 18:00 └──────────────────────┘                                              │
│ 19:00                                                                        │
│                                                                               │
│ Загрузка: 9/8 часов (113%) 🔴                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Виджеты для дашборда

#### 1. Сводка по загрузке (сегодня)
```
┌─────────────────────────────────┐
│ 📊 Загрузка монтажников         │
├─────────────────────────────────┤
│ Всего монтажников: 5            │
│                                  │
│ 🟢 Доступны:       2 (40%)      │
│ 🟡 Загружены:      2 (40%)      │
│ 🔴 Перегружены:    1 (20%)      │
│                                  │
│ Всего часов работ: 28/50 (56%)  │
│                                  │
│ [Подробнее →]                   │
└─────────────────────────────────┘
```

#### 2. Незапланированные заявки
```
┌─────────────────────────────────┐
│ ⏳ Ожидают планирования         │
├─────────────────────────────────┤
│ #127 - ул. Ленина 56  🔴 Срочно│
│ #129 - ул. Мира 12              │
│ #131 - ул. Садовая 8   🟡 Высок│
│ #133 - ул. Лесная 5             │
│                                  │
│ Всего: 12 заявок                │
│                                  │
│ [Запланировать →]               │
└─────────────────────────────────┘
```

#### 3. Текущие работы (в процессе)
```
┌─────────────────────────────────┐
│ 🔧 В работе сейчас              │
├─────────────────────────────────┤
│ #115 - Иванов (08:00-10:00)    │
│ ▓▓▓▓▓▓▓▓▓▓░░░░░░ 60%          │
│                                  │
│ #88 - Бригада №1 (10:00-14:00) │
│ ▓▓▓▓▓░░░░░░░░░░░ 25%          │
│                                  │
│ [Обновить →]                    │
└─────────────────────────────────┘
```

---

## 🚀 План реализации

### Этап 1: Минимальная функциональность (2 недели)
**Цель:** Базовое планирование для индивидуальных монтажников

#### Неделя 1: Backend + БД
- [ ] **Миграция 012:** добавить поля планирования в `zakaz_applications`
  - `scheduled_date DATE`
  - `scheduled_time_start TIME`
  - `scheduled_time_end TIME`
  - `estimated_duration_hours DECIMAL(4,2)`
  - `actual_start_at TIMESTAMPTZ`
  - `actual_end_at TIMESTAMPTZ`
  - `work_notes TEXT`
  - Индексы для быстрого поиска
- [ ] **API:** `PATCH /api/applications/[id]/schedule` - планирование работы
  - Валидация дат и времени
  - Проверка конфликтов расписания
  - Логирование в audit_log
- [ ] **API:** `GET /api/workload/engineers?date=YYYY-MM-DD` - загрузка монтажников
  - Расчет часов работы
  - Список свободных слотов
  - Статус загрузки (available/busy/overloaded)
- [ ] **Утилиты:** `lib/scheduling-utils.ts` - функции расчета
  - `calculateWorkloadStatus()`
  - `timesOverlap()`
  - `calculateDurationHours()`
- [ ] Обновить типы в `lib/types.ts`

#### Неделя 2: Frontend (интеграция с существующим кодом)
- [ ] **Расширить модалку назначения** в `app/dashboard/applications/[id]/page.tsx`
  - Добавить поля даты и времени
  - Показывать загрузку при выборе даты
  - Предупреждать о конфликтах
  - Использовать существующую структуру модалки
- [ ] **Компонент:** `app/components/EngineerWorkloadCard.tsx`
  - Карточка с загрузкой монтажника
  - Список запланированных работ
  - Свободные временные слоты
- [ ] **Страница:** `/dashboard/schedule` - простой календарь
  - Таблица: монтажники × дни недели
  - Цветовая индикация загрузки (🟢🟡🔴)
  - Ссылки на заявки
- [ ] **Обновить карточку заявки** - показывать дату/время планирования
  - Отображать `scheduled_date` рядом с исполнителем
  - Кнопка "Изменить планирование"

**Результат:**
- ✅ Можно назначать И планировать через одну модалку
- ✅ Видна загрузка монтажников при назначении
- ✅ Простой календарь для обзора недели
- ✅ Интеграция с существующим UI

---

### Этап 2: Улучшенный UI (2 недели)
**Цель:** Удобный дашборд с календарем

#### Неделя 3: Календарь
- [ ] Компонент `WeekCalendar` - календарь на неделю с временными слотами
- [ ] Drag-and-drop для переноса заявок (библиотека `react-dnd`)
- [ ] Визуализация конфликтов расписания
- [ ] Фильтры по монтажникам
- [ ] Переключение день/неделя/месяц

#### Неделя 4: Дашборд
- [ ] Страница `/dashboard/workload` - дашборд загрузки
- [ ] Виджет "Сводка по загрузке"
- [ ] Виджет "Незапланированные заявки"
- [ ] Виджет "Текущие работы"
- [ ] Статистика и графики (библиотека `recharts`)

**Результат:**
- ✅ Удобный календарь с drag-and-drop
- ✅ Наглядный дашборд загрузки
- ✅ Быстрое переназначение заявок

---

### Этап 3: Бригады (3 недели)
**Цель:** Поддержка бригад и расширенное планирование

#### Неделя 5: БД + API
- [ ] Таблицы: `brigades`, `brigade_members`, `work_assignments`
- [ ] Миграция данных из `applications.assigned_to` в `work_assignments`
- [ ] API: `/api/brigades` - управление бригадами
- [ ] API: `/api/work-assignments` - создание/обновление назначений
- [ ] Обновить API загрузки для поддержки бригад

#### Неделя 6-7: UI для бригад
- [ ] Страница `/dashboard/brigades` - управление бригадами
- [ ] Обновить модальное окно планирования для выбора бригад
- [ ] Показывать состав бригады в календаре
- [ ] Расчет загрузки для бригад (сумма загрузки всех участников)

**Результат:**
- ✅ Можно создавать бригады
- ✅ Назначать бригады на заявки
- ✅ Видна загрузка бригад

---

### Этап 4: Отслеживание выполнения (2 недели)
**Цель:** Контроль фактического времени выполнения

#### Неделя 8-9
- [ ] Поля: `actual_start_at`, `actual_end_at`, `actual_duration_hours`
- [ ] API: `POST /api/work-assignments/{id}/start` - начать работу
- [ ] API: `POST /api/work-assignments/{id}/complete` - завершить работу
- [ ] Мобильный UI для монтажников: кнопки "Начать" / "Завершить"
- [ ] Отчет: сравнение планового и фактического времени
- [ ] Push-уведомления при начале работы

**Результат:**
- ✅ Монтажники могут отмечать начало/конец работы
- ✅ Видны отклонения от плана
- ✅ Статистика точности планирования

---

## 🤔 Альтернативные подходы

### Подход А: Без таблицы work_assignments (проще)
**Идея:** Все хранить в полях `zakaz_applications`

**Плюсы:**
- Проще реализация
- Меньше JOIN-ов в запросах
- Понятнее структура

**Минусы:**
- Нельзя назначить несколько человек (только бригада целиком)
- Нет истории переназначений
- Сложнее масштабировать

**Когда использовать:** Если нужно быстро, и не планируется сложная логика

---

### Подход Б: С таблицей work_assignments (сложнее, но гибче)
**Идея:** Отдельная таблица для всех назначений

**Плюсы:**
- История назначений
- Гибкость (можно добавлять поля)
- Несколько назначений на одну заявку (если нужно переназначить)
- Легче делать отчеты

**Минусы:**
- Сложнее код
- Больше JOIN-ов
- Дольше разработка

**Когда использовать:** Если нужна гибкость и планируется расширение

---

### Подход В: Гибридный (рекомендуется)
**Идея:** Начать с простого, предусмотреть миграцию

1. **MVP (быстро):** Добавить поля в `applications`
   - `scheduled_date`, `scheduled_time_start/end`
   - Быстро запустить планирование

2. **Рефакторинг (позже):** Создать `work_assignments`
   - Мигрировать данные
   - Добавить бригады
   - Сохранить обратную совместимость

**Плюсы:**
- Быстрый старт
- Поэтапная разработка
- Меньше рисков

---

## 📋 Контрольный список решений

### Что нужно решить перед началом разработки:

- [ ] **Бригады или только индивидуалы?**
  - Нужны ли бригады в MVP?
  - Можно ли отложить на 2-й этап?

- [ ] **Рабочие часы:**
  - Стандартный рабочий день: с какого до какого часа?
  - Максимальная загрузка в день?
  - Учитывать ли выходные?

- [ ] **Планирование:**
  - Можно ли планировать за пределами рабочего дня?
  - Что делать с конфликтами (2 работы в одно время)?
  - Автоматически подсказывать свободные слоты?

- [ ] **Приоритеты:**
  - Какой минимальный функционал нужен срочно?
  - Что можно отложить на 2-ю итерацию?

- [ ] **Интеграции:**
  - Нужны ли уведомления в Telegram?
  - Синхронизация с Google Calendar?

---

## 🔄 Обратная совместимость и миграция

### Что нужно учесть:

#### 1. Существующие заявки
- В БД уже есть заявки с назначенными монтажниками
- Поля планирования будут `NULL` для старых заявок
- **Решение:** Все новые поля опциональные, старые заявки продолжат работать

#### 2. API endpoints
- Текущий API `/api/applications/[id]/assign` продолжит работать
- Новый API `/api/applications/[id]/schedule` - дополнительный функционал
- **Решение:** Не ломаем существующие endpoints, добавляем новые

#### 3. UI компоненты
- Модалка назначения уже используется в коде
- Нужно расширить, не сломав текущий функционал
- **Решение:** Добавить новый режим "с планированием" (опционально)

#### 4. Переход с варианта 1 на вариант 2
Если начнем с простого варианта (поля в `applications`), а потом захотим бригады:

```sql
-- Миграция для перехода на work_assignments
-- 1. Создать новые таблицы
CREATE TABLE zakaz_work_assignments (...);

-- 2. Мигрировать данные
INSERT INTO zakaz_work_assignments (
  application_id, engineer_id, scheduled_date, ...
)
SELECT
  id, assigned_to, scheduled_date, ...
FROM zakaz_applications
WHERE scheduled_date IS NOT NULL;

-- 3. Добавить ссылку
ALTER TABLE zakaz_applications
ADD COLUMN current_assignment_id UUID REFERENCES zakaz_work_assignments(id);

-- 4. Старые поля пометить deprecated (не удалять сразу!)
-- Постепенный переход в коде
```

---

## 💡 Рекомендации

### Для быстрого старта (MVP за 2 недели): ⭐ РЕКОМЕНДУЕТСЯ
1. **Выбрать подход А** (без work_assignments)
2. Добавить поля планирования в `applications`
3. Расширить существующую модалку назначения
4. Простой календарь на неделю
5. Базовый расчет загрузки
6. Без drag-and-drop (добавить позже)
7. **Интеграция с текущим UI** (минимум изменений)

**Преимущества:**
- ✅ Минимальные изменения в существующем коде
- ✅ Обратная совместимость
- ✅ Быстрое тестирование на пользователях
- ✅ Можно мигрировать на подход Б позже

### Для полноценного решения (4-6 недель):
1. **Выбрать подход Б** (с work_assignments)
2. Поддержка бригад с самого начала
3. Drag-and-drop календарь
4. Расширенный дашборд
5. Отслеживание фактического времени
6. История переназначений

**Когда выбирать:**
- Если точно нужны бригады в ближайшее время
- Если готовы потратить больше времени на разработку
- Если нужна детальная история назначений

### Техники для успеха:
- 🎯 Начать с минимального, но работающего функционала
- 📊 Регулярно показывать прогресс заказчику
- 🔄 Итеративная разработка: MVP → улучшения → расширение
- 🧪 Тестировать на реальных данных с самого начала
- 📝 Документировать API и UI сразу
- 🔗 **Использовать существующие компоненты** (модалки, типы, API)
- ⚡ **Не ломать работающий код** - добавлять, а не заменять

---

## ❓ Вопросы для обсуждения

1. Какой подход выбрать: А (простой) или Б (гибкий)?
2. Нужны ли бригады в MVP или можно отложить?
3. Какой рабочий день у монтажников?
4. Есть ли особые требования к календарю?
5. Нужна ли интеграция с другими системами?

---

**Следующий шаг:** Обсудить план и принять решения по ключевым вопросам.
