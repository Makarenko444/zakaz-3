#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–ø–ª–æ—è –¥–ª—è zakaz3.tomica.ru
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./pr-zakaz3.sh

# –ù–ê–°–¢–†–û–ô–ö–ò - –∏–∑–º–µ–Ω–∏—Ç–µ –∏–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞ PM2 –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ
PM2_PROCESS_NAME="zakaz-3"  # –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –∏–º—è –≤–∞—à–µ–≥–æ PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–ª—è zakaz3

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∏–Ω–∞—é –¥–µ–ø–ª–æ–π –Ω–∞ zakaz3.tomica.ru..."
echo ""

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd ~/projects/zakaz-3

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ GitHub..."
git pull origin main

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ package.json –∏–∑–º–µ–Ω–∏–ª—Å—è)
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –±–∏–ª–¥–∞
echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–≥–æ –±–∏–ª–¥–∞..."
rm -rf .next

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞ '$PM2_PROCESS_NAME'..."
if pm2 describe "$PM2_PROCESS_NAME" > /dev/null 2>&1; then
  pm2 restart "$PM2_PROCESS_NAME"
else
  echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å PM2 '$PM2_PROCESS_NAME' –Ω–µ –Ω–∞–π–¥–µ–Ω!"
  echo ""
  echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã:"
  pm2 list
  echo ""
  echo "‚ùå –ò–∑–º–µ–Ω–∏—Ç–µ PM2_PROCESS_NAME –≤ —Å–∫—Ä–∏–ø—Ç–µ pr-zakaz3.sh –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è"
  exit 1
fi

echo ""
echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üåê –û—Ç–∫—Ä–æ–π—Ç–µ https://zakaz3.tomica.ru"
echo "üí° –ù–µ –∑–∞–±—É–¥—å—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+Shift+R)"
