# Миграции 033-034: Добавление поля город в заявки

## Описание

Эти миграции добавляют поле `city` (город) в таблицу заявок и извлекают город из существующих адресов.

## Проблема

В старых заявках адрес хранился в одном поле `street_and_house` в разных форматах:
- "Томск, ул. Иркутский тракт, 193а, 66"
- "г Томск, пер Совпартшкольный, д. 13"
- "Северск, ул. Ленина, 10"
- "ЗАТО Северск, ул. Мира, 5"
- "Красноармейская, 82, 1" (без города — подразумевается Томск)

## Решение

### Миграция 033: Добавление поля city
- Добавляет колонку `city VARCHAR(100)` с дефолтом "Томск"
- Создаёт индекс для поиска по городу

### Миграция 034: Извлечение города из адресов
- Парсит `street_and_house` и извлекает город
- Обновляет поле `city` для записей с явным городом
- Удаляет город из начала `street_and_house`

## Порядок выполнения

### Шаг 1: Выполнить миграцию 033
```sql
-- Выполнить в SQL Editor
\i database/migrations/033_add_city_to_applications.sql
```

### Шаг 2: Проверить preview миграции 034
```sql
-- Выполнить первые части (PREVIEW и STATISTICS)
-- Они покажут, какие записи будут изменены
```

### Шаг 3: Применить изменения
```sql
-- Раскомментировать ЧАСТЬ 3 в миграции 034 и выполнить
```

### Шаг 4: Проверить результаты
```sql
SELECT city, COUNT(*) FROM zakaz_applications GROUP BY city ORDER BY cnt DESC;
```

## Ожидаемые результаты

| Город | Примерное кол-во |
|-------|------------------|
| Томск | ~18000 (включая дефолт) |
| Северск | ~80 |

## Затрагиваемые записи

- ~550 записей с "Томск, ..." или "г Томск, ..."
- ~80 записей с "Северск", "г Северск" или "ЗАТО Северск"
- ~3 записи с "Томская обл, ..."

Остальные ~17800 записей получат дефолтное значение "Томск".

## Откат

```sql
-- Удалить поле city
ALTER TABLE zakaz_applications DROP COLUMN IF EXISTS city;

-- Откат изменений street_and_house невозможен автоматически
-- Потребуется восстановление из бэкапа
```

## Примечания

- Перед выполнением рекомендуется сделать бэкап таблицы
- Миграция 034 содержит preview-режим для проверки перед применением
