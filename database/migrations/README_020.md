# Миграция 020-022: Система нормализации адресов

**Дата:** 2025-11-21
**Автор:** Claude AI
**Связанные миграции:** 020, 021, 022

## Обзор

Эта серия миграций реализует систему нормализации адресов для заявок. Позволяет привязывать заявки с произвольно введенными адресами к формализованному справочнику адресов города с помощью fuzzy поиска.

## Проблема

В системе заявок абоненты указывают адреса в произвольной форме:
- "Ленина 5"
- "ул.Ленина д5"
- "Lenin st 5"

Все эти варианты описывают один и тот же адрес, но выглядят по-разному. Это создает проблемы:
- Невозможно группировать заявки по реальному адресу
- Сложно вести статистику по адресам
- Нет связи с техническими узлами подключения

## Решение

### Архитектура

**Двухуровневая модель адресов:**

1. **Свободный адрес** (`street_and_house` в `zakaz_applications`)
   - Вводится абонентом/менеджером при создании заявки
   - Хранится "как есть" для истории
   - Может содержать опечатки и нестандартное написание

2. **Формализованный адрес** (`zakaz_addresses`)
   - Справочник всех адресов города
   - Структурированные поля: `street`, `house`
   - Единственный источник правды для группировки

3. **Статус привязки** (`address_match_status`)
   - `unmatched` - адрес не привязан к справочнику
   - `manual_matched` - адрес привязан вручную менеджером
   - `auto_matched` - резерв для будущего автоматического поиска

### Рабочий процесс

```
1. Абонент звонит → Менеджер создает заявку с адресом в свободной форме
   ↓
2. При просмотре заявки менеджер видит: "Не привязан к формализованному адресу"
   ↓
3. Менеджер нажимает "Привязать" → Открывается мастер поиска адресов
   ↓
4. Система автоматически ищет похожие адреса (fuzzy search)
   ↓
5. Менеджер выбирает правильный адрес → Привязка сохранена
   ↓
6. Все заявки с этим формализованным адресом теперь группируются вместе
```

## Технические детали

### Миграция 020: Добавление статуса привязки

```sql
CREATE TYPE address_match_status AS ENUM ('unmatched', 'auto_matched', 'manual_matched');

ALTER TABLE zakaz_applications
  ADD COLUMN address_match_status address_match_status DEFAULT 'unmatched' NOT NULL;
```

**Что делает:**
- Создает enum тип для статуса привязки
- Добавляет поле `address_match_status` в таблицу заявок
- Обновляет существующие заявки (если address_id заполнен → 'manual_matched')
- Создает индекс для быстрого поиска непривязанных заявок

### Миграция 021: Индексы для fuzzy поиска

```sql
CREATE EXTENSION IF NOT EXISTS pg_trgm;

CREATE INDEX idx_addresses_street_trgm
  ON zakaz_addresses USING gin(street gin_trgm_ops);
```

**Что делает:**
- Устанавливает расширение `pg_trgm` (триграммы) для нечеткого поиска
- Создает GIN индекс для быстрого fuzzy поиска по улице
- Создает обычные индексы для точного поиска по дому

**Как работает fuzzy search:**
- PostgreSQL разбивает строку на триграммы (последовательности из 3 символов)
- Пример: "Ленина" → ["Лен", "ени", "нин", "ина"]
- При поиске "Ленна" → ["Лен", "енн", "нна"] → находит похожие строки
- Возвращает результаты с коэффициентом схожести (similarity)

### Миграция 022: Функция поиска

```sql
CREATE FUNCTION search_addresses_fuzzy(search_query TEXT)
RETURNS TABLE (id, street, house, similarity, ...)
```

**Что делает:**
- Создает PostgreSQL функцию для нечеткого поиска адресов
- Ищет по улице, дому и их комбинации
- Возвращает до 20 наиболее похожих адресов
- Сортирует по убыванию схожести (similarity DESC)

## API изменения

### Новый endpoint: GET /api/addresses/search

**Запрос:**
```
GET /api/addresses/search?query=ленина+5
```

**Ответ:**
```json
{
  "addresses": [
    {
      "id": "uuid",
      "street": "ул. Ленина",
      "house": "5",
      "similarity": 0.85,
      "full_address": "ул. Ленина, 5"
    }
  ]
}
```

### Обновленный endpoint: PATCH /api/applications/:id

**Новые поля:**
```json
{
  "address_id": "uuid",
  "address_match_status": "manual_matched"
}
```

## UI изменения

### 1. Карточка заявки

Добавлен блок "Формализованный адрес":

**Если привязан:**
```
Формализованный адрес: ✓ ул. Ленина, 5 [Изменить]
```

**Если не привязан:**
```
Статус: ⚠ Не привязан к формализованному адресу [Привязать]
```

### 2. Мастер привязки адресов (обновлен)

**Изменения:**
- Вместо загрузки всех адресов → использует fuzzy search API
- Debounce для поиска (300ms)
- Индикатор загрузки при поиске
- Отображение коэффициента схожести
- Автоматический поиск при открытии по адресу из заявки

## Применение миграций

### Вручную через psql:

```bash
psql -U your_user -d your_database -f database/migrations/020_add_address_match_status.sql
psql -U your_user -d your_database -f database/migrations/021_add_address_search_indexes.sql
psql -U your_user -d your_database -f database/migrations/022_create_address_search_function.sql
```

### Через Supabase Dashboard:

1. Перейти в SQL Editor
2. Скопировать содержимое каждой миграции
3. Выполнить по порядку (020 → 021 → 022)

## Тестирование

### 1. Проверка расширения pg_trgm:

```sql
SELECT * FROM pg_extension WHERE extname = 'pg_trgm';
```

### 2. Проверка индексов:

```sql
SELECT * FROM pg_indexes WHERE tablename = 'zakaz_addresses';
```

### 3. Тестирование fuzzy search:

```sql
-- Должен найти "ул. Ленина" даже с опечаткой
SELECT * FROM search_addresses_fuzzy('Ленна 5');

-- Проверка similarity
SELECT
  street,
  similarity(street, 'Ленина') as sim
FROM zakaz_addresses
ORDER BY sim DESC
LIMIT 5;
```

### 4. Проверка UI:

1. Создать заявку с адресом "Ленина 5"
2. Открыть карточку заявки
3. Проверить, что отображается "Не привязан..."
4. Нажать "Привязать"
5. Проверить, что мастер открылся и показал похожие адреса
6. Привязать адрес
7. Проверить, что статус изменился на "Формализованный адрес: ✓ ..."

## Откат (Rollback)

Если нужно откатить миграции:

```sql
-- Откат 022
DROP FUNCTION IF EXISTS search_addresses_fuzzy(TEXT);

-- Откат 021
DROP INDEX IF EXISTS idx_addresses_street_trgm;
DROP INDEX IF EXISTS idx_addresses_house;
DROP INDEX IF EXISTS idx_addresses_street_house;
DROP EXTENSION IF EXISTS pg_trgm;

-- Откат 020
DROP INDEX IF EXISTS idx_applications_match_status;
ALTER TABLE zakaz_applications DROP COLUMN address_match_status;
DROP TYPE IF EXISTS address_match_status;
```

## Будущие улучшения

### Фаза 2 (опционально):

1. **Автоматическая привязка при создании**
   - При создании заявки сразу предлагать похожие адреса
   - Если similarity > 0.8 → автоматически привязывать

2. **Таблица маппингов**
   - Создать `zakaz_address_mappings`
   - Хранить историю вариантов написания
   - Обучать систему: "ул Ленина 5" всегда → "ул. Ленина, 5"

3. **Статистика**
   - Дашборд непривязанных адресов
   - Список самых частых вариантов написания
   - Автоматические предложения для пакетной привязки

4. **Интеграция с ФИАС**
   - Загрузка справочника адресов из ФИАС
   - Автоматическая нормализация по ФИАС API

## Производительность

**Ожидаемая нагрузка:** 20 заявок в день

**Индексы:**
- GIN индекс `idx_addresses_street_trgm`: ~2-3 MB для 10000 адресов
- Обычные индексы: минимальный overhead

**Скорость поиска:**
- Без индексов: ~50-100ms для 10000 адресов (seq scan)
- С GIN индексом: ~2-5ms (index scan)

**Рекомендации:**
- При росте справочника до 100k+ адресов рассмотреть партиционирование
- Monitoring: следить за размером индексов и временем выполнения search_addresses_fuzzy()

## Безопасность

- Все изменения логируются в `zakaz_audit_log`
- Изменение привязки требует роли `manager` или выше
- SQL injection защита: используются prepared statements

## Поддержка

При возникновении проблем проверить:

1. Установлено ли расширение pg_trgm
2. Созданы ли индексы (запрос выше)
3. Есть ли данные в zakaz_addresses
4. Логи Supabase при выполнении search_addresses_fuzzy()

## Changelog

- **2025-11-21**: Начальная реализация (миграции 020-022)
