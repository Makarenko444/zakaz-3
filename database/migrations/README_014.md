# Миграция 014: Обновление ролей пользователей

**Дата:** 2025-11-20
**Файл:** `014_update_user_roles.sql`

## Описание

Обновление системы ролей пользователей в соответствии с новой структурой.

## Изменения

### Старые роли → Новые роли

| Старая роль | Новая роль | Действие |
|-------------|------------|----------|
| `operator`  | `manager`  | Переименование |
| `lead`      | `manager`  | Объединение с manager |
| `admin`     | `admin`    | Без изменений |
| `engineer`  | `engineer` | Без изменений |
| -           | `installer`| Новая роль |
| -           | `supply`   | Новая роль |

### Новая структура ролей

1. **admin** - Администратор
   - Полный доступ к системе
   - Администрирование (пользователи, адреса, статусы)

2. **manager** - Менеджер
   - Управление заявками
   - Назначение исполнителей
   - Работа с клиентами

3. **engineer** - Инженер
   - Выполнение работ
   - Редактирование заявок
   - Комментарии и файлы

4. **installer** - Монтажник
   - Только просмотр заявок
   - Добавление комментариев
   - Загрузка файлов
   - БЕЗ редактирования заявок

5. **supply** - Снабжение
   - Управление материалами
   - Просмотр заявок
   - Комментарии

## Как применить миграцию

⚠️ **ВАЖНО:** Миграция состоит из двух шагов из-за ограничений PostgreSQL с ENUM типами.

### Вариант 1: Использование скрипта (рекомендуется)

```bash
# Установите переменную окружения с URL базы данных
export POSTGRES_URL="postgresql://user:password@host:port/database"

# Запустите скрипт (выполняет оба шага автоматически)
./database/apply-migration-014.sh
```

### Вариант 2: Через Supabase Dashboard (вручную в два шага)

**Шаг 1:**
1. Откройте Supabase Dashboard → SQL Editor
2. Скопируйте содержимое файла `014_update_user_roles_step1.sql`
3. Выполните SQL (нажмите Run)
4. Дождитесь завершения

**Шаг 2:**
1. В том же SQL Editor
2. Скопируйте содержимое файла `014_update_user_roles_step2.sql`
3. Выполните SQL (нажмите Run)

### Вариант 3: Напрямую через psql

```bash
# Шаг 1: Добавление новых значений
psql "$POSTGRES_URL" -f database/migrations/014_update_user_roles_step1.sql

# Подождите пару секунд для фиксации транзакции

# Шаг 2: Обновление данных
psql "$POSTGRES_URL" -f database/migrations/014_update_user_roles_step2.sql
```

## Что делает миграция

### Шаг 1 (014_update_user_roles_step1.sql)
1. **Добавляет новые значения** в enum `zakaz_user_role`:
   - `manager`
   - `installer`
   - `supply`

### Шаг 2 (014_update_user_roles_step2.sql)
1. **Обновляет существующие записи:**
   - `operator` → `manager`
   - `lead` → `manager`
2. **Пересоздает enum** с только актуальными значениями
3. **Удаляет старые значения** (`operator`, `lead`)
4. **Обновляет комментарий** к полю `role`

## Проверка после миграции

Проверьте, что миграция применена успешно:

```sql
-- Проверка constraint
SELECT conname, consrc
FROM pg_constraint
WHERE conrelid = 'zakaz_users'::regclass
  AND conname = 'zakaz_users_role_check';

-- Проверка обновленных ролей
SELECT role, COUNT(*)
FROM zakaz_users
GROUP BY role;
```

## Откат (если необходимо)

⚠️ **ВНИМАНИЕ:** Откат миграции приведет к потере разграничения между manager и бывшими operator/lead.

```sql
-- Откат к старым ролям (НЕ РЕКОМЕНДУЕТСЯ)
ALTER TABLE zakaz_users DROP CONSTRAINT zakaz_users_role_check;
ALTER TABLE zakaz_users
ADD CONSTRAINT zakaz_users_role_check
CHECK (role IN ('admin', 'operator', 'engineer', 'lead'));

-- Примечание: автоматический откат manager → operator/lead невозможен
```

## Влияние на код приложения

После применения миграции убедитесь, что обновлены:

- ✅ `lib/types.ts` - тип UserRole
- ✅ `components/Sidebar.tsx` - отображение ролей
- ✅ `app/components/admin/UsersAdmin.tsx` - форма редактирования
- ✅ `app/dashboard/applications/[id]/page.tsx` - фильтр назначения

Все эти файлы уже обновлены в коммите.

## Безопасность

- Миграция безопасна для production
- Не удаляет данные
- Только обновляет существующие роли
- Все пользователи сохраняют доступ к системе

## Тестирование

После применения миграции:

1. Проверьте вход существующих пользователей
2. Создайте нового пользователя с каждой ролью
3. Проверьте редактирование пользователя
4. Убедитесь, что права доступа работают корректно
