# История изменений

## [19.11.2025] - Улучшение карточки заявки и исправление поиска

### Изменено
- **Формат отображения информации о заявке** (`app/dashboard/applications/[id]/page.tsx`)
  - Переработан макет информационного блока в двухколоночный формат
  - **Первая колонка:**
    - Создана: [Автор] (дата, время)
    - Обновлена: [Кто обновил] (дата, время)
  - **Вторая колонка:**
    - Услуга: [Название услуги]
    - Менеджер: [Имя менеджера]
  - Улучшена читаемость и структурированность информации

### Исправлено
- **Ошибка загрузки заявки** (`app/api/applications/[id]/route.ts`, `app/dashboard/applications/[id]/page.tsx`)
  - Проблема: При попытке получить `updated_by_user` через foreign key возникала ошибка, так как внешний ключ не был настроен корректно
  - Решение: Информация о пользователе, обновившем заявку, теперь загружается отдельным запросом на фронтенде из списка пользователей
  - Убран несуществующий join `updated_by_user` из API запроса

- **Проблема с поиском по заявкам** (`app/api/applications/route.ts`, `app/dashboard/applications/page.tsx`)
  - Проблема: Поиск не работал из-за поля `customer_company`, которое может быть NULL для физических лиц. В Supabase PostgREST OR-запрос с `ilike` некорректно обрабатывает NULL значения
  - Решение: Убрано поле `customer_company` из поискового запроса
  - Теперь поиск работает по полям:
    - `customer_fullname` (ФИО клиента)
    - `customer_phone` (Телефон)
    - `street_and_house` (Адрес подключения)
  - Обновлен placeholder в поисковой строке: "Поиск по ФИО, телефону или адресу..."

- **Отображение автора заявки в карточке** (`app/api/applications/[id]/route.ts`)
  - Проблема: Автор заявки отображался некорректно из-за неправильного синтаксиса внешних ключей
  - Решение: Использованы явные имена foreign key constraints вместо имен столбцов:
    - `assigned_user:zakaz_users!zakaz_applications_assigned_to_fkey`
    - `created_by_user:zakaz_users!zakaz_applications_created_by_fkey`

### Технические детали
- Файлы изменены:
  - `app/api/applications/[id]/route.ts` - API получения заявки
  - `app/api/applications/route.ts` - API списка заявок и поиска
  - `app/dashboard/applications/[id]/page.tsx` - Карточка заявки
  - `app/dashboard/applications/page.tsx` - Список заявок

---

## [19.11.2025] - Улучшения страницы узлов подключения и навигации

### Добавлено
- **Таблица узлов подключения с расширенным функционалом** (`app/dashboard/nodes/page.tsx`)
  - Поиск по адресу и комментарию
  - Мультивыбор фильтров по статусам заявок
  - Табличное представление с компактным дизайном
  - Сортировка по столбцам:
    - Адрес узла (по улице и дому)
    - Общее количество заявок
    - Количество заявок по каждому статусу
  - Столбцы статусов упорядочены по полю `sort_order` из таблицы статусов

- **Кликабельные адреса узлов** (`app/dashboard/nodes/page.tsx`)
  - При клике на адрес узла происходит переход на страницу заявок с автоматической фильтрацией по этому адресу
  - Передача параметров: `address_id`, `address_street`, `address_house`

- **Фильтрация заявок по адресу** (`app/dashboard/applications/page.tsx`)
  - Поддержка URL параметров для фильтрации по адресу
  - Визуальный баннер с информацией об активном фильтре
  - Кнопка сброса фильтра

- **Кликабельный узел в карточке заявки** (`app/dashboard/applications/[id]/page.tsx`)
  - Бейдж с адресом узла теперь кликабелен
  - При клике происходит переход на список заявок, отфильтрованных по этому узлу

- **Расширенный поиск по заявкам** (`app/api/applications/route.ts`)
  - Добавлен поиск по 4 полям:
    - ФИО клиента (`customer_fullname`)
    - Организация (`customer_company`)
    - Телефон (`customer_phone`)
    - Адрес подключения (`street_and_house`)
  - Экранирование специальных символов SQL LIKE (`%`, `_`)
  - Логирование поисковых запросов для отладки

### Исправлено
- **Ошибка типизации в API адресов** (`app/api/addresses/route.ts`)
  - Проблема: TypeScript ошибка "Property 'id' does not exist on type 'never'"
  - Решение: Добавлены явные TypeScript интерфейсы и `.returns<Address[]>()` для Supabase запросов

- **Ошибка useSearchParams** (`app/dashboard/applications/page.tsx`)
  - Проблема: "useSearchParams() should be wrapped in a suspense boundary"
  - Решение: Разделен компонент на `ApplicationsPage` и `ApplicationsContent`, обернут в Suspense boundary

- **Ошибки ESLint для неиспользуемых переменных** (`eslint.config.mjs`)
  - Добавлено правило игнорирования переменных с префиксом underscore:
    - `argsIgnorePattern: "^_"`
    - `varsIgnorePattern: "^_"`
    - `caughtErrorsIgnorePattern: "^_"`

- **Проблемы с кодировкой UTF-8** (`app/dashboard/nodes/page.tsx`)
  - Исправлена порча русского текста при сохранении файла
  - Файл полностью переписан с корректной кодировкой

### Изменено
- Улучшен пользовательский опыт навигации между узлами и заявками
- Добавлена связность интерфейса через кликабельные элементы
- Оптимизирован поиск с учетом безопасности (экранирование SQL)

---

## Коммиты

```
d42cf02 Исправлен поиск по заявкам
cd81c89 Исправлена ошибка загрузки заявки
8d1bb29 Изменен формат отображения информации о заявке
478f1a6 Исправлено отображение автора заявки в карточке
444bd04 Улучшен поиск: добавлено экранирование и логирование для отладки
7d67d50 Добавлена кликабельность узла в карточке заявки и расширен поиск
0f1688e Добавлена фильтрация заявок по адресу и кликабельные ссылки в таблице узлов
634cdfa Сортировка статусов в таблице узлов по полю sort_order из БД
bf976d5 Улучшена страница узлов подключения: табличный вид с поиском, фильтрами и сортировкой
2b7661a Исправлена ошибка типизации в API адресов
```

## Текущее состояние проекта

- ✅ Все сборки проходят успешно
- ✅ ESLint не выдает ошибок
- ✅ TypeScript типизация корректна
- ✅ Поиск работает корректно
- ✅ Навигация между узлами и заявками работает
- ✅ Карточка заявки отображает информацию в новом формате
