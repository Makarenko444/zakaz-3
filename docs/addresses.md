# Правила работы с адресами

## Общие принципы

### 1. Свободный ввод адреса
- Пользователь вводит адрес **в любом формате**, как ему удобно
- Система **не добавляет автоматически** слова "улица", "проспект", "переулок" и т.д.
- Если пользователь ввёл "Ленина 15" — так и сохраняется
- Если пользователь ввёл "проспект Ленина 15" — так и сохраняется

### 2. Проверка на дубликаты
Перед созданием нового адреса система:
1. Ищет похожие адреса в справочнике
2. Если найдены похожие — показывает их пользователю
3. Пользователь может выбрать существующий адрес или создать новый

### 3. Автоподсказки улиц
При вводе названия улицы:
- Система предлагает варианты из существующего справочника
- Подсказки появляются после ввода 2+ символов
- Пользователь может выбрать подсказку или ввести своё значение

## Структура адреса

| Поле | Обязательное | Описание |
|------|--------------|----------|
| Город | Да | По умолчанию "Томск" |
| Улица | Да | Название улицы в любом формате |
| Дом | Да | Номер дома (может включать букву: 15а, 15/1) |
| Строение | Нет | Корпус, строение, литера |

## Примеры корректных адресов

```
✓ улица Ленина, 15
✓ Ленина 15
✓ проспект Кирова, 51а
✓ Кирова 51а
✓ Московский тракт, 2г
✓ пер. Батенькова, 7
✓ переулок Батенькова, 7
```

## Поиск адресов

### В справочнике адресов (`/dashboard/addresses`)
- Поиск работает по всем полям: улица, дом, полный адрес
- При поиске страница сбрасывается на первую
- Поиск регистронезависимый

### При привязке заявки
- Поиск ищет по локальному справочнику и OSM
- Локальные адреса показываются первыми
- При выборе адреса из OSM он добавляется в локальный справочник

## Массовые операции (для администраторов)

### Замена текста в адресах
API: `POST /api/admin/addresses/replace-text`

```json
{
  "search": "просп.",
  "replace": "проспект",
  "field": "street",
  "dryRun": true
}
```

Параметры:
- `search` — текст для поиска
- `replace` — текст для замены
- `field` — поле для замены (`street` или `address`)
- `dryRun` — режим предпросмотра (не изменяет данные)

### Скрипт для замены
```bash
npx ts-node scripts/replace-address-text.ts
```

Перед запуском отредактируйте константы `SEARCH` и `REPLACE` в файле.

## Привязка заявок к адресам

### Из карточки заявки
1. Открыть заявку
2. Нажать "Привязать к адресу"
3. Выбрать существующий адрес из поиска **или** создать новый
4. При создании нового — проверяются дубликаты

### Из админки (массовая привязка)
Страница: Администрирование → Привязка по адресам

Два режима работы:
1. **От заявок к адресам** — выбираем заявку, ищем/создаём адрес
2. **От адресов к заявкам** — выбираем адрес, привязываем похожие заявки

## Рекомендации

1. **Используйте автоподсказки** — это помогает избежать дубликатов
2. **Проверяйте похожие адреса** — перед созданием нового
3. **Единообразие** — старайтесь использовать одинаковый формат для одинаковых улиц
4. **Не сокращайте** — лучше "проспект" чем "просп." или "пр."
