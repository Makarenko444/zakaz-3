# Отчет о прогрессе - 12 декабря 2025

## Обзор

Выполнена повторная очистка production сервера от вредоносного ПО, обновление Next.js для закрытия критической RCE уязвимости, создание скрипта автоматической проверки безопасности и установка fail2ban на оба сервера.

## Обнаруженные угрозы

### 1. Повторное заражение криптомайнером

Вредоносное ПО вернулось на production сервер через сутки после первой очистки (11.12.2025).

| Процесс | Путь | PID | RAM | Время работы |
|---------|------|-----|-----|--------------|
| Майнер #1 | `/tmp/fghgf` | 3487681 | 4.5 GB (13.6%) | 53+ часа |
| Майнер #2 | `~/.local/share/next` | 246448 | 4.5 GB (13.5%) | 8 часов |

**Конфигурация майнера:** `/tmp/ijnegrrinje.json`

**Нагрузка сервера:** Load Average 36-39 (при норме ~5)

---

### 2. Критическая уязвимость Next.js

Обнаружена причина повторного заражения - **критическая RCE уязвимость** в Next.js 15.5.4:

| CVE | Описание | Критичность |
|-----|----------|-------------|
| GHSA-9qr9-h5gf-34mp | RCE в React flight protocol | **Критическая** |
| GHSA-w37m-7fhw-fmv9 | Утечка исходного кода Server Actions | Высокая |
| GHSA-mwv6-3258-q52c | DoS с Server Components | Высокая |

Через эту уязвимость злоумышленник мог выполнить произвольный код на сервере и загрузить криптомайнер.

---

### 3. Проблемы с Docker контейнерами

| Контейнер | Проблема | CPU |
|-----------|----------|-----|
| supabase-meta | unhealthy, высокий CPU | 98% |
| supabase-studio | Высокий CPU | 61% |
| supabase-analytics | Повышенный CPU | 60% |

---

## Выполненные действия

### 1. Удаление вредоносных процессов

```bash
# Убить криптомайнер #1
kill -9 3487681

# Убить криптомайнер #2 (замаскированный под Next.js)
kill -9 246448

# Удалить вредоносные файлы
rm -f /tmp/fghgf /tmp/ijnegrrinje.json
rm -f ~/.local/share/next
```

**Статус:** ✅ Выполнено

---

### 2. Обновление Next.js

```bash
# Production сервер (zakaz2.tomica.ru)
cd ~/projects/zakaz-2
npm install next@15.5.9
npm run build
pm2 restart zakaz-2

# Development сервер (zakaz3.tomica.ru)
cd ~/projects/zakaz-3
npm install next@15.5.9
npm run build
pm2 restart zakaz-3
```

**Версия:** 15.5.4 → 15.5.9

**Статус:** ✅ Оба сервера обновлены

---

### 3. Установка fail2ban

```bash
# Установка на оба сервера
sudo apt install fail2ban -y
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

**Защита:** Автоматическая блокировка IP после неудачных попыток SSH входа

**Статус:** ✅ Установлен на оба сервера

---

### 4. Перезапуск проблемных Docker контейнеров

```bash
docker restart supabase-meta
docker restart supabase-studio
```

**Результат:** CPU supabase-studio снизился с 61% до 0%

**Статус:** ✅ Выполнено

---

### 5. Создание скрипта проверки безопасности

Создан скрипт `scripts/security-check.sh` версии 2.0 с проверками:

| Проверка | Описание |
|----------|----------|
| Нагрузка системы | Умный порог (2x от кол-ва ядер) |
| Криптомайнеры | Известные процессы (xmrig, minerd и др.) |
| Замаскированные процессы | `/tmp/fghgf`, `~/.local/share/next` |
| Процессы из /tmp | С высоким потреблением памяти |
| Вредоносные файлы | В /tmp, ~/.local/share, проектах |
| Скрытые JS файлы | Исключая легитимные конфиги |
| Bashrc/Profile | Инъекции кода |
| Crontab | Подозрительные задачи |
| Systemd сервисы | system-update-service и др. |
| PM2 процессы | Сломанные с множеством рестартов |
| Docker контейнеры | CPU > 80% |
| NPM уязвимости | Critical и High |

**Статус:** ✅ Скрипт создан и протестирован

---

## Результаты

### Нагрузка production сервера

| Метрика | До очистки | После очистки | Изменение |
|---------|------------|---------------|-----------|
| Load Average (1 min) | 36 | 4.5 | **-87%** |
| Load Average (5 min) | 39 | 18 | -54% |
| Load Average (15 min) | 37 | 27 | -27% |

---

### Статус серверов после работы

| Сервер | URL | Next.js | Fail2ban | Статус |
|--------|-----|---------|----------|--------|
| Production | zakaz2.tomica.ru | 15.5.9 | ✅ | ✅ Работает |
| Development | zakaz3.tomica.ru | 15.5.9 | ✅ | ✅ Работает |

---

## Анализ вектора атаки

### Подтвержденный способ проникновения

**Next.js RCE уязвимость (GHSA-9qr9-h5gf-34mp)**

Злоумышленник использовал критическую уязвимость в Next.js 15.5.0-15.5.7, которая позволяет выполнить произвольный код через React flight protocol. Это объясняет:

1. Почему вирус вернулся после первой очистки
2. Почему .bashrc был чистым (не нужен для персистентности)
3. Почему crontab был чистым

### Новые индикаторы компрометации (IOC)

| Тип | Значение | Описание |
|-----|----------|----------|
| Файл | `/tmp/fghgf` | Криптомайнер |
| Файл | `/tmp/ijnegrrinje.json` | Конфиг майнера |
| Файл | `~/.local/share/next` | Замаскированный майнер |
| Процесс | `*` с 4+ GB RAM из /tmp | Подозрительный |

---

## Рекомендации по безопасности

### Выполнено

- [x] Удалить вредоносные процессы и файлы
- [x] Обновить Next.js до безопасной версии
- [x] Установить fail2ban
- [x] Создать скрипт автоматической проверки
- [x] Перезапустить проблемные Docker контейнеры

### Рекомендуемые действия

- [ ] Регулярно запускать `./scripts/security-check.sh`
- [ ] Настроить мониторинг нагрузки (Prometheus/Grafana)
- [ ] Рассмотреть смену SSH ключей
- [ ] Следить за обновлениями Next.js (`npm outdated`)

### Мониторинг

Регулярно выполнять:

```bash
# Быстрая проверка безопасности
./scripts/security-check.sh

# Проверка нагрузки
uptime

# Проверка обновлений npm
npm outdated

# Статус fail2ban
sudo fail2ban-client status sshd
```

---

## Использование скрипта проверки

### Запуск

```bash
cd ~/projects/zakaz-2  # или zakaz-3
./scripts/security-check.sh
```

### Что проверяет скрипт

1. Нагрузку системы (с учетом кол-ва ядер)
2. Криптомайнеры и замаскированные процессы
3. Вредоносные файлы в /tmp, ~/.local/share, проектах
4. Инъекции в bashrc/profile
5. Crontab записи
6. Systemd сервисы
7. PM2 процессы
8. Docker контейнеры с высоким CPU
9. Сетевые подключения
10. SSH ключи
11. NPM уязвимости

### Пример вывода

```
╔════════════════════════════════════════════════════════════════╗
║        ПРОВЕРКА БЕЗОПАСНОСТИ СЕРВЕРА - 2025-12-12 10:57        ║
╚════════════════════════════════════════════════════════════════╝

═══ 1. НАГРУЗКА СИСТЕМЫ ═══
CPU ядер: 12
Load Average: 4.47 (1 мин), 18.39 (5 мин), 26.30 (15 мин)
✓ Нагрузка в норме

...

╔════════════════════════════════════════════════════════════════╗
║                        ИТОГОВЫЙ ОТЧЕТ                          ║
╚════════════════════════════════════════════════════════════════╝
✓ Угрозы не обнаружены!
```

---

## Восстановление Supabase Studio

После очистки сервера Supabase Studio перестал показывать таблицы ("Failed to retrieve tables").

**Причина:** Контейнер `supabase-meta` (отвечает за метаданные таблиц) не был запущен.

**Решение:**
```bash
cd ~/directus/supabase/docker
docker compose up -d
docker restart supabase-studio
```

**Статус:** ✅ Supabase Studio работает

---

## Статистика сессии

- **Время работы:** ~1.5 часа
- **Вредоносных процессов убито:** 2
- **Вредоносных файлов удалено:** 3
- **Снижение нагрузки:** с 36 до 4.5 (в 8 раз)
- **Серверов обновлено:** 2
- **Fail2ban установлен на:** 2 сервера
- **Supabase Studio:** восстановлен

---

## Заключение

Сервер был повторно скомпрометирован через критическую RCE уязвимость в Next.js. После обновления Next.js до 15.5.9 вектор атаки закрыт. Установлен fail2ban для защиты от SSH брутфорса. Создан скрипт автоматической проверки безопасности для регулярного мониторинга.

**Важно:** Регулярно обновлять зависимости и запускать проверку безопасности.

---

**Дата:** 12 декабря 2025
**Серверы:** zakaz2.tomica.ru (prod), zakaz3.tomica.ru (dev)
**Ветка:** `claude/server-security-check-017rXpZ4Hc1X3Zz2V5uSr2W2`
**Статус:** ✅ Очистка завершена, защита усилена
