# Отчет о прогрессе - 16 декабря 2025

## Обзор

Выполнена масштабная работа по улучшению модуля нарядов (work orders) и календаря планирования. Добавлены история исполнения, умный подбор исполнителей, валидация при создании нарядов и улучшена визуализация в календаре.

## Выполненные задачи

### 1. История исполнения наряда

Добавлен блок "История исполнения" на странице наряда:

#### Функционал:
- ✅ Отображение кто создал наряд и когда
- ✅ Timeline всех изменений статуса
- ✅ Запись изменений при редактировании наряда
- ✅ Цветовая индикация по типу изменения
- ✅ Расположение в правой колонке (1/3 ширины)

#### Визуализация:
- Вертикальная линия времени
- Цветные точки по типу события:
  - Создание (индиго)
  - Выдан (жёлтый)
  - В работе (синий)
  - Выполнен (зелёный)
  - Отменён (красный)

**Файлы:**
- `app/api/work-orders/[id]/history/route.ts` - API истории
- `app/api/work-orders/[id]/route.ts` - добавлена запись в историю при PATCH

### 2. Запись редактирования в историю

При редактировании наряда теперь записывается детальная информация об изменениях:

```
Редактирование: Дата: 2025-12-15 → 2025-12-16; Время: 09:00 → 10:00
```

**Отслеживаемые поля:**
- Тип наряда
- Дата
- Время
- Длительность
- Примечания
- Результат

### 3. Умный подбор исполнителей

При добавлении исполнителей теперь работает интеллектуальная сортировка:

#### Порядок сортировки:
1. **Текущий пользователь (автор)** - всегда первый с меткой "вы"
2. **Популярные исполнители** - те, кого автор чаще всего назначает (метка "часто")
3. **Остальные** - по алфавиту

#### Поиск:
- ✅ Поле поиска по имени исполнителя
- ✅ Фильтрация в реальном времени

**Файлы:**
- `app/api/users/[id]/popular-executors/route.ts` - API популярных исполнителей
- `app/components/WorkOrdersSection.tsx` - интеграция в форму создания
- `app/dashboard/work-orders/[id]/page.tsx` - интеграция в детальный просмотр

### 4. Валидация при создании наряда

Добавлена обязательная валидация:
- ✅ Дата выполнения работ
- ✅ Время начала работ
- ✅ Продолжительность работ

При отсутствии полей показывается красное сообщение об ошибке.

### 5. Улучшения календаря

#### Дневной вид:
- ✅ Исполнители в первом столбце на отдельных строках (было через запятую)
- ✅ Полные имена исполнителей (было только фамилия)

#### Блок "Загрузка по сотрудникам":
- ✅ Упрощённая цветовая схема (единая для всех)
- ✅ Шкала загрузки относительно 8-часового рабочего дня:
  - **Зелёный** — загрузка в часах
  - **Светло-серый** — свободное время
  - **Красный** — переработка (>8 часов)
- ✅ Подписи шкалы с указанием переработки

### 6. Перестановка блоков

На странице детального просмотра наряда:
- ✅ Блоки "Примечания" и "Материалы" поменяны местами
- ✅ Блок "Файлы" перенесён в правую колонку под "Историю исполнения"
- ✅ Удалён дублирующийся блок "Создан/Изменён" (информация есть в истории)

## Структура API

### Наряды (Work Orders)

```
/api/work-orders
├── GET    - список нарядов с фильтрами
├── POST   - создание наряда
│
/api/work-orders/[id]
├── GET    - детали наряда
├── PATCH  - редактирование + запись в историю
├── DELETE - удаление наряда
│
/api/work-orders/[id]/status
├── PATCH  - смена статуса
│
/api/work-orders/[id]/executors
├── POST   - добавить исполнителя
├── DELETE - удалить исполнителя
│
/api/work-orders/[id]/materials
├── POST   - добавить материал
├── DELETE - удалить материал
│
/api/work-orders/[id]/files
├── GET    - список файлов наряда
│
/api/work-orders/[id]/complete
├── POST   - завершить наряд с отчётом
│
/api/work-orders/[id]/history
└── GET    - история изменений
```

### Популярные исполнители

```
/api/users/[id]/popular-executors
└── GET - топ-10 исполнителей по частоте использования
```

## База данных

### Таблицы нарядов

| Таблица | Описание |
|---------|----------|
| `zakaz_work_orders` | Основная таблица нарядов |
| `zakaz_work_order_executors` | Исполнители нарядов (many-to-many) |
| `zakaz_work_order_materials` | Материалы нарядов |
| `zakaz_work_order_status_history` | История изменений статусов |

### Миграции

```bash
database/migrations/038_create_work_orders_table.sql
database/migrations/039_create_work_order_executors_table.sql
database/migrations/040_create_work_order_materials_table.sql
database/migrations/041_create_work_order_status_history_table.sql
database/migrations/042_add_work_order_id_to_files.sql
```

## Технические детали

### Типы нарядов

| Тип | Код | Описание |
|-----|-----|----------|
| Осмотр и расчёт | `survey` | Выезд на объект для оценки |
| Монтаж | `installation` | Выполнение работ |

### Статусы нарядов

| Статус | Код | Описание |
|--------|-----|----------|
| Черновик | `draft` | Наряд создан, не выдан |
| Выдан | `assigned` | Наряд выдан исполнителям |
| В работе | `in_progress` | Исполнители работают |
| Выполнен | `completed` | Работы завершены |
| Отменён | `cancelled` | Наряд отменён |

### Структура истории изменений

```typescript
interface StatusHistoryEntry {
  id: string
  work_order_id: string
  old_status: string | null
  new_status: string
  changed_by: string | null
  changed_by_user?: { full_name: string }
  comment: string | null
  changed_at: string
}
```

## Решённые проблемы

### 1. История не записывалась
**Причина:** Не передавался `user_id` при смене статуса
**Решение:** Добавлена передача `user_id: currentUser?.id` во все API вызовы

### 2. Создатель наряда не отображался в истории
**Причина:** Supabase join синтаксис не работал для `created_by`
**Решение:** Отдельный запрос для получения данных создателя

### 3. Популярные исполнители не работали
**Причина:** `created_by` не передавался при создании наряда
**Решение:** Добавлено `created_by: currentUser?.id` в `handleCreateWorkOrder`

### 4. Ошибка сборки "JSX namespace"
**Причина:** TypeScript не находил тип JSX.Element
**Решение:** Замена на `React.ReactElement[]` с импортом React

### 5. Warning "unused maxHours"
**Причина:** Переменная больше не использовалась после рефакторинга
**Решение:** Удалена из деструктуризации useMemo

## Файлы изменений

### Созданные файлы
- `app/api/users/[id]/popular-executors/route.ts`
- `app/api/work-orders/[id]/history/route.ts`

### Изменённые файлы
- `app/dashboard/work-orders/[id]/page.tsx` - детальный просмотр наряда
- `app/components/WorkOrdersSection.tsx` - секция нарядов в заявке
- `app/api/work-orders/[id]/route.ts` - добавлена запись истории при PATCH
- `app/api/work-orders/[id]/complete/route.ts` - исправлена запись истории
- `app/dashboard/schedule/page.tsx` - улучшения календаря

## Коммиты

1. `feat: история редактирования нарядов и улучшение отображения имён`
2. `fix: отображение полных имён исполнителей в календаре`
3. `feat: улучшения календаря - круговая диаграмма и отображение исполнителей`
4. `fix: исправлены ошибки сборки (JSX namespace, unused maxHours)`
5. `fix: упрощена цветовая схема загрузки сотрудников (зелёный/серый/красный)`

## Следующие шаги

- [ ] Печатная форма наряда
- [ ] Массовое создание нарядов
- [ ] Уведомления исполнителям
- [ ] Интеграция с мобильным приложением
- [ ] Экспорт отчётов по нарядам

---

**Дата:** 16 декабря 2025
**Ветка:** `claude/plan-work-orders-01KKsghFZyN7MSmd3CxRZRUw`
**Статус:** ✅ Завершено успешно
