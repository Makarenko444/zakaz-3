# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –¥–µ–ø–ª–æ—è

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞

–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
- **2808 zombie –ø—Ä–æ—Ü–µ—Å—Å–æ–≤** - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞!
- **Load average: 8.03** –ø—Ä–∏ 8 –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —è–¥—Ä–∞—Ö (–∏–∑ 32 –¥–æ—Å—Ç—É–ø–Ω—ã—Ö)
- **11GB RAM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** –∏–∑ 16GB
- **–ù–µ—Ç swap –ø–∞–º—è—Ç–∏**

## –£–∑–∫–∏–µ –º–µ—Å—Ç–∞ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ

1. **npm install** - –º–µ–¥–ª–µ–Ω–Ω–æ –∏–∑-–∑–∞ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ CPU –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è swap
2. **npm build** - –º–µ–¥–ª–µ–Ω–Ω–æ –∏–∑-–∑–∞ zombie –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
3. **PM2 restart** - –±—ã—Å—Ç—Ä–æ

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

### üî¥ 1. –°–†–û–ß–ù–û: –£–±—Ä–∞—Ç—å zombie –ø—Ä–æ—Ü–µ—Å—Å—ã

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh makarenko@78.140.57.33

# –ù–∞–π–¥–∏—Ç–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã zombie'–æ–≤
ps -A -ostat,ppid,pid,cmd | grep -e '^[Zz]' | awk '{print $2}' | sort | uniq

# –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã —Å–æ–∑–¥–∞—é—Ç zombie
ps -ef | grep -E "$(ps -A -ostat,ppid | grep -e '^[Zz]' | awk '{print $2}' | sort | uniq | tr '\n' '|' | sed 's/|$//')"

# –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º–∞ –≤ Docker - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ
sudo systemctl restart docker

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ zombie –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
ps aux | grep 'Z' | wc -l

# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 0 –∏–ª–∏ –±–ª–∏–∑–∫–æ –∫ 0
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –°–Ω–∏–∑–∏—Ç load average —Å 8 –¥–æ 2-3, —É—Å–∫–æ—Ä–∏—Ç –¥–µ–ø–ª–æ–π –Ω–∞ **50-70%**

### üü† 2. –í–ê–ñ–ù–û: –î–æ–±–∞–≤–∏—Ç—å swap –ø–∞–º—è—Ç—å

```bash
# –°–æ–∑–¥–∞–π—Ç–µ 4GB swap —Ñ–∞–π–ª
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# –°–¥–µ–ª–∞–π—Ç–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º (–ø–µ—Ä–µ–∂–∏–≤—ë—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É)
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ swappiness (–∫–∞–∫ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å swap)
sudo sysctl vm.swappiness=10
echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ
free -h
swapon --show
```

**–≠—Ñ—Ñ–µ–∫—Ç:** npm install –Ω–µ –±—É–¥–µ—Ç –ø–∞–¥–∞—Ç—å –ø—Ä–∏ –ø–∏–∫–∞—Ö –ø–∞–º—è—Ç–∏, —É—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ **20-30%**

### üü° 3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å npm cache

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
cd ~/apps/zakaz-3

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—Ä –∫–µ—à–∞
du -sh ~/.npm

# –ï—Å–ª–∏ –Ω—É–∂–Ω–æ - –æ—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –∫–µ—à
npm cache clean --force

# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ .npmrc —Å–æ–∑–¥–∞–Ω (—É–∂–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏)
cat .npmrc
```

**–≠—Ñ—Ñ–µ–∫—Ç:** npm install —Å 2-3 –º–∏–Ω—É—Ç –¥–æ **30-60 —Å–µ–∫—É–Ω–¥**

## –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—É–∂–µ —Å–¥–µ–ª–∞–Ω—ã)

‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `.npmrc` —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏:
- `prefer-offline=true` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à –ø–µ—Ä–≤—ã–º
- `maxsockets=3` - –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ—Ä–≤–µ—Ä
- `audit=false` - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å audit –ø—Ä–∏ –¥–µ–ø–ª–æ–µ
- `fund=false` - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Å–ø–æ–Ω—Å–æ—Ä—Å—Ç–≤–µ

‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `next.config.ts`:
- `output: 'standalone'` - –º–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä —Å–±–æ—Ä–∫–∏
- `swcMinify: true` - –±—ã—Å—Ç—Ä–∞—è –º–∏–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω deployment —Å–∫—Ä–∏–ø—Ç:
- `--prefer-offline` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à npm
- `--no-audit` - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pnpm –≤–º–µ—Å—Ç–æ npm

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pnpm
npm install -g pnpm

# –û–±–Ω–æ–≤–∏—Ç–µ package.json scripts
# "build": "pnpm build"
# "dev": "pnpm dev"

# –û–±–Ω–æ–≤–∏—Ç–µ deployment —Å–∫—Ä–∏–ø—Ç
# npm ci -> pnpm install --frozen-lockfile
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –£—Å–∫–æ—Ä–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –Ω–∞ **40-50%**, –º–µ–Ω—å—à–µ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ

### 5. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã

```bash
# –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–∫–æ–ª—å–∫–æ –ø–∞–º—è—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker stats --no-stream

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker ps -a
docker stop <container_id>

# –û—á–∏—Å—Ç–∏—Ç–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
docker system prune -a
```

### 6. –î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è PM2

```bash
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ ecosystem.config.js
nano ~/apps/zakaz-3/ecosystem.config.js

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ª–∏–º–∏—Ç—ã:
# max_memory_restart: '1G'  # –£–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
# instances: 1  # –£–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (–±—ã–ª–æ 2)
```

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- npm install: **2-3 –º–∏–Ω—É—Ç—ã**
- npm build: **1.5-2 –º–∏–Ω—É—Ç—ã**
- **–û–±—â–µ–µ –≤—Ä–µ–º—è –¥–µ–ø–ª–æ—è: 5-8 –º–∏–Ω—É—Ç**

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- npm install: **30-60 —Å–µ–∫—É–Ω–¥** (-60%)
- npm build: **60-90 —Å–µ–∫—É–Ω–¥** (-40%)
- **–û–±—â–µ–µ –≤—Ä–µ–º—è –¥–µ–ø–ª–æ—è: 2-3 –º–∏–Ω—É—Ç—ã** (-60%)

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
```bash
# Load average
uptime

# CPU –∏ –ø–∞–º—è—Ç—å
htop

# Zombie –ø—Ä–æ—Ü–µ—Å—Å—ã
ps aux | grep 'Z' | wc -l

# Swap –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
free -h
```

### –õ–æ–≥–∏ –¥–µ–ø–ª–æ—è
```bash
# GitHub Actions
# https://github.com/Makarenko444/zakaz-3/actions

# PM2 –ª–æ–≥–∏
pm2 logs zakaz-3 --lines 100

# Nginx –ª–æ–≥–∏
sudo tail -f /var/log/nginx/zakaz2.tomica.ru-access.log
```

## –í—ã–¥–µ–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤

–ï—Å–ª–∏ –≤—ã –º–æ–∂–µ—Ç–µ –≤—ã–¥–µ–ª–∏—Ç—å –±–æ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ VPS:

### CPU
- **–¢–µ–∫—É—â–∏–µ:** 8 —è–¥–µ—Ä –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑ 32 –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PM2 –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–µ —è–¥—Ä–∞
- **–ö–æ–º–∞–Ω–¥–∞:** `lscpu` –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ CPU affinity –¥–ª—è PM2

### RAM
- **–¢–µ–∫—É—â–∏–µ:** 16GB (11GB –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
  - –ï—Å–ª–∏ <10GB —Å–≤–æ–±–æ–¥–Ω–æ –ø–æ—Å–ª–µ —á–∏—Å—Ç–∫–∏ zombie - –¥–æ–±–∞–≤—å—Ç–µ –¥–æ 24GB
  - –ï—Å–ª–∏ >10GB —Å–≤–æ–±–æ–¥–Ω–æ - —Ç–µ–∫—É—â–µ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

### –î–∏—Å–∫
- **–¢–µ–∫—É—â–∏–µ:** 77GB —Å–≤–æ–±–æ–¥–Ω–æ –∏–∑ 100GB
- **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –Ω–æ –æ—á–∏—Å—Ç–∏—Ç–µ Docker –∫–µ—à: `docker system prune -a`

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –¥–µ–ø–ª–æ–π
cd ~/apps/zakaz-3
time ./scripts/deploy-server.sh

# –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è: 2-3 –º–∏–Ω—É—Ç—ã –≤–º–µ—Å—Ç–æ 5-8
```

## –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–æ–±–∞–≤—å—Ç–µ –≤ cron –ø—Ä–æ–≤–µ—Ä–∫—É zombie –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:

```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ crontab
crontab -e

# –î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å)
0 * * * * ZOMBIE_COUNT=$(ps aux | grep 'Z' | wc -l); if [ $ZOMBIE_COUNT -gt 100 ]; then systemctl restart docker; fi
```

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –¥–µ–ø–ª–æ–π –≤—Å—ë –µ—â—ë –º–µ–¥–ª–µ–Ω–Ω—ã–π –ø–æ—Å–ª–µ —ç—Ç–∏—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `pm2 logs zakaz-3` –Ω–∞ –æ—à–∏–±–∫–∏
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `htop` –≤–æ –≤—Ä–µ–º—è –¥–µ–ø–ª–æ—è
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `docker stats` - –Ω–µ —Å—ä–µ–¥–∞—é—Ç –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤—Å—é –ø–∞–º—è—Ç—å
